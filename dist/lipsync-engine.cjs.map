{"version":3,"file":"lipsync-engine.cjs","sources":["../src/utils/EventEmitter.js","../src/utils/audio-utils.js","../src/core/visemes.js","../src/analyzers/FrequencyAnalyzer.js","../src/core/LipSyncEngine.js","../src/renderers/CSSClassRenderer.js","../src/renderers/CanvasRenderer.js","../src/utils/RingBuffer.js","../src/renderers/SVGMouthRenderer.js","../src/index.js"],"sourcesContent":["/**\n * Lightweight typed event emitter with wildcard support.\n * @module EventEmitter\n */\nexport class EventEmitter {\n  /** @type {Map<string, Set<Function>>} */\n  #listeners = new Map();\n\n  /**\n   * Subscribe to an event.\n   * @param {string} event - Event name, or '*' for all events.\n   * @param {Function} fn - Callback receiving (...args).\n   * @returns {() => void} Unsubscribe function.\n   */\n  on(event, fn) {\n    if (!this.#listeners.has(event)) {\n      this.#listeners.set(event, new Set());\n    }\n    this.#listeners.get(event).add(fn);\n    return () => this.off(event, fn);\n  }\n\n  /**\n   * Subscribe to an event once.\n   * @param {string} event\n   * @param {Function} fn\n   * @returns {() => void}\n   */\n  once(event, fn) {\n    const wrapper = (...args) => {\n      this.off(event, wrapper);\n      fn(...args);\n    };\n    wrapper._original = fn;\n    return this.on(event, wrapper);\n  }\n\n  /**\n   * Unsubscribe from an event.\n   * @param {string} event\n   * @param {Function} fn\n   */\n  off(event, fn) {\n    const set = this.#listeners.get(event);\n    if (!set) return;\n    set.delete(fn);\n    // Also remove `once` wrappers\n    for (const listener of set) {\n      if (listener._original === fn) {\n        set.delete(listener);\n      }\n    }\n    if (set.size === 0) this.#listeners.delete(event);\n  }\n\n  /**\n   * Emit an event.\n   * @param {string} event\n   * @param  {...any} args\n   */\n  emit(event, ...args) {\n    const set = this.#listeners.get(event);\n    if (set) {\n      for (const fn of set) fn(...args);\n    }\n    // Wildcard listeners\n    const wildcard = this.#listeners.get('*');\n    if (wildcard) {\n      for (const fn of wildcard) fn(event, ...args);\n    }\n  }\n\n  /** Remove all listeners, optionally for a specific event. */\n  removeAllListeners(event) {\n    if (event) {\n      this.#listeners.delete(event);\n    } else {\n      this.#listeners.clear();\n    }\n  }\n\n  /** Number of listeners for an event. */\n  listenerCount(event) {\n    return this.#listeners.get(event)?.size ?? 0;\n  }\n}\n","/**\n * Audio format conversion and DSP utility functions.\n * @module audio-utils\n */\n\n/**\n * Convert Int16 PCM samples to Float32 [-1, 1].\n * @param {Int16Array} int16 - Input PCM samples.\n * @returns {Float32Array}\n */\nexport function int16ToFloat32(int16) {\n  const float32 = new Float32Array(int16.length);\n  for (let i = 0; i < int16.length; i++) {\n    float32[i] = int16[i] / 32768.0;\n  }\n  return float32;\n}\n\n/**\n * Convert Float32 [-1, 1] samples to Int16 PCM.\n * @param {Float32Array} float32 - Input samples.\n * @returns {Int16Array}\n */\nexport function float32ToInt16(float32) {\n  const int16 = new Int16Array(float32.length);\n  for (let i = 0; i < float32.length; i++) {\n    const s = Math.max(-1, Math.min(1, float32[i]));\n    int16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;\n  }\n  return int16;\n}\n\n/**\n * Decode a base64-encoded PCM16 chunk to Int16Array.\n * Common when receiving audio from WebSocket APIs (OpenAI Realtime, ElevenLabs).\n * @param {string} base64 - Base64-encoded PCM16 audio.\n * @returns {Int16Array}\n */\nexport function base64ToInt16(base64) {\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return new Int16Array(bytes.buffer);\n}\n\n/**\n * Encode Int16Array to base64 string.\n * @param {Int16Array} int16\n * @returns {string}\n */\nexport function int16ToBase64(int16) {\n  const bytes = new Uint8Array(int16.buffer);\n  let binary = '';\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary);\n}\n\n/**\n * Calculate RMS (Root Mean Square) amplitude of a signal.\n * @param {Float32Array|Uint8Array} data - Audio samples.\n * @param {boolean} [isByte=false] - If true, treats data as unsigned byte (0-255) from AnalyserNode.\n * @returns {number} RMS value [0, 1].\n */\nexport function calculateRMS(data, isByte = false) {\n  let sumSquares = 0;\n  const len = data.length;\n  if (len === 0) return 0;\n\n  for (let i = 0; i < len; i++) {\n    const value = isByte ? (data[i] - 128) / 128 : data[i];\n    sumSquares += value * value;\n  }\n  return Math.sqrt(sumSquares / len);\n}\n\n/**\n * Calculate zero-crossing rate (indicator of noisiness / fricatives).\n * @param {Float32Array} data\n * @returns {number} Crossings per sample (0..1).\n */\nexport function zeroCrossingRate(data) {\n  if (data.length < 2) return 0;\n  let crossings = 0;\n  for (let i = 1; i < data.length; i++) {\n    if ((data[i] >= 0 && data[i - 1] < 0) || (data[i] < 0 && data[i - 1] >= 0)) {\n      crossings++;\n    }\n  }\n  return crossings / (data.length - 1);\n}\n\n/**\n * Extract frequency band energies from FFT data.\n * @param {Uint8Array} frequencyData - From AnalyserNode.getByteFrequencyData().\n * @param {number} sampleRate - Audio context sample rate.\n * @param {Array<{name: string, min: number, max: number}>} [bands] - Custom frequency bands.\n * @returns {Object<string, number>} Band energies normalized 0..1.\n */\nexport function extractBandEnergies(frequencyData, sampleRate, bands) {\n  const defaultBands = bands || [\n    { name: 'sub',      min: 20,   max: 200  },  // Fundamental freq, voiced sounds\n    { name: 'low',      min: 200,  max: 800  },  // First formant region\n    { name: 'mid',      min: 800,  max: 2500 },  // Second formant region\n    { name: 'high',     min: 2500, max: 5500 },  // Fricatives, sibilants\n    { name: 'veryHigh', min: 5500, max: 12000 }, // Plosive bursts, high sibilants\n  ];\n\n  const binCount = frequencyData.length;\n  const nyquist = sampleRate / 2;\n  const binWidth = nyquist / binCount;\n  const result = {};\n\n  for (const band of defaultBands) {\n    const startBin = Math.max(0, Math.floor(band.min / binWidth));\n    const endBin = Math.min(binCount - 1, Math.floor(band.max / binWidth));\n    \n    if (startBin >= endBin) {\n      result[band.name] = 0;\n      continue;\n    }\n\n    let sum = 0;\n    let count = 0;\n    for (let i = startBin; i <= endBin; i++) {\n      sum += frequencyData[i] / 255;\n      count++;\n    }\n    result[band.name] = count > 0 ? sum / count : 0;\n  }\n\n  return result;\n}\n\n/**\n * Smooth a value toward a target using exponential moving average.\n * @param {number} current - Current smoothed value.\n * @param {number} target - Target raw value.\n * @param {number} factor - Smoothing factor (0 = no smoothing, 1 = no change).\n * @returns {number}\n */\nexport function smoothValue(current, target, factor) {\n  return current + (target - current) * (1 - factor);\n}\n\n/**\n * Linear interpolation between two values.\n * @param {number} a\n * @param {number} b\n * @param {number} t - Interpolation factor [0, 1].\n * @returns {number}\n */\nexport function lerp(a, b, t) {\n  return a + (b - a) * Math.max(0, Math.min(1, t));\n}\n\n/**\n * Clamp a value between min and max.\n * @param {number} value\n * @param {number} min\n * @param {number} max\n * @returns {number}\n */\nexport function clamp(value, min, max) {\n  return Math.max(min, Math.min(max, value));\n}\n\n/**\n * Resample Float32 audio from one sample rate to another (linear interpolation).\n * @param {Float32Array} input\n * @param {number} fromRate\n * @param {number} toRate\n * @returns {Float32Array}\n */\nexport function resample(input, fromRate, toRate) {\n  if (fromRate === toRate) return input;\n  const ratio = fromRate / toRate;\n  const outputLength = Math.round(input.length / ratio);\n  const output = new Float32Array(outputLength);\n  for (let i = 0; i < outputLength; i++) {\n    const srcIndex = i * ratio;\n    const low = Math.floor(srcIndex);\n    const high = Math.min(low + 1, input.length - 1);\n    const frac = srcIndex - low;\n    output[i] = input[low] * (1 - frac) + input[high] * frac;\n  }\n  return output;\n}\n","/**\n * Viseme definitions, mappings, and phoneme data.\n *\n * Supports two standard sets:\n *   - EXTENDED (15 shapes) — Oculus/MPEG-4 standard\n *   - SIMPLE   (6 shapes)  — Preston Blair / Hanna-Barbera\n *\n * @module visemes\n */\n\n// ─── Extended 15-shape set (Oculus OVRLipSync compatible) ────────────────────\n\nexport const EXTENDED_VISEMES = /** @type {const} */ ({\n  sil: { label: 'Silent',     description: 'Mouth closed, neutral' },\n  PP:  { label: 'P/B/M',      description: 'Lips pressed together' },\n  FF:  { label: 'F/V',        description: 'Lower lip to upper teeth' },\n  TH:  { label: 'TH',         description: 'Tongue between teeth' },\n  DD:  { label: 'D/T/N/L',    description: 'Tongue to upper palate' },\n  kk:  { label: 'K/G',        description: 'Back of tongue raised' },\n  CH:  { label: 'CH/SH/J',    description: 'Lips pursed forward' },\n  SS:  { label: 'S/Z',        description: 'Teeth close, slight smile' },\n  nn:  { label: 'N/NG',       description: 'Mouth slightly open, nasal' },\n  RR:  { label: 'R',          description: 'Lips slightly rounded' },\n  aa:  { label: 'AA/AH',      description: 'Wide open mouth' },\n  E:   { label: 'EH/AE',      description: 'Mouth open, slight smile' },\n  I:   { label: 'IH/IY',      description: 'Small opening, smile' },\n  O:   { label: 'OH/AO',      description: 'Rounded, medium open' },\n  U:   { label: 'UW/OW',      description: 'Small rounded opening' },\n});\n\n/** @type {string[]} Ordered list of extended viseme keys. */\nexport const EXTENDED_VISEME_KEYS = Object.keys(EXTENDED_VISEMES);\n\n// ─── Simple 6-shape set (Preston Blair / Hanna-Barbera) ─────────────────────\n\nexport const SIMPLE_VISEMES = /** @type {const} */ ({\n  A: { label: 'Rest / M/B/P closed',  extendedMap: ['sil'] },\n  B: { label: 'M / B / P',            extendedMap: ['PP', 'nn'] },\n  C: { label: 'EE / S / soft sounds',  extendedMap: ['E', 'I', 'SS'] },\n  D: { label: 'AH / wide open',       extendedMap: ['aa', 'DD', 'kk'] },\n  E: { label: 'OH / round',           extendedMap: ['O', 'RR', 'CH'] },\n  F: { label: 'OO / F / V / tight',   extendedMap: ['FF', 'TH', 'U'] },\n});\n\n/** @type {string[]} Ordered list of simple viseme keys. */\nexport const SIMPLE_VISEME_KEYS = Object.keys(SIMPLE_VISEMES);\n\n// ─── Extended → Simple mapping ──────────────────────────────────────────────\n\n/** @type {Object<string, string>} */\nexport const EXTENDED_TO_SIMPLE = {};\nfor (const [simpleKey, def] of Object.entries(SIMPLE_VISEMES)) {\n  for (const ext of def.extendedMap) {\n    EXTENDED_TO_SIMPLE[ext] = simpleKey;\n  }\n}\n\n// ─── CMU/ARPABET Phoneme → Extended Viseme ──────────────────────────────────\n\nexport const PHONEME_TO_VISEME = /** @type {const} */ ({\n  // Vowels\n  AA: 'aa', AE: 'E',  AH: 'aa', AO: 'O',  AW: 'aa',\n  AY: 'aa', EH: 'E',  ER: 'RR', EY: 'E',  IH: 'I',\n  IY: 'I',  OW: 'O',  OY: 'O',  UH: 'U',  UW: 'U',\n  // Consonants\n  B:  'PP', CH: 'CH', D:  'DD', DH: 'TH', F:  'FF',\n  G:  'kk', HH: 'aa', JH: 'CH', K:  'kk', L:  'DD',\n  M:  'PP', N:  'nn', NG: 'nn', P:  'PP', R:  'RR',\n  S:  'SS', SH: 'CH', T:  'DD', TH: 'TH', V:  'FF',\n  W:  'U',  Y:  'I',  Z:  'SS', ZH: 'CH',\n});\n\n/** @type {string[]} All known ARPABET phonemes. */\nexport const ARPABET_PHONEMES = Object.keys(PHONEME_TO_VISEME);\n\n// ─── Viseme transition weights (coarticulation hints) ───────────────────────\n// Higher weight = slower transition (more blending needed)\n\n/** @type {Object<string, Object<string, number>>} */\nexport const TRANSITION_WEIGHTS = {\n  sil: { aa: 0.3, E: 0.3, I: 0.3, O: 0.3, U: 0.3, PP: 0.2, FF: 0.2 },\n  aa:  { sil: 0.4, E: 0.5, O: 0.6, I: 0.5, PP: 0.3, SS: 0.3 },\n  PP:  { aa: 0.2, sil: 0.2, E: 0.3, FF: 0.4 },\n  FF:  { aa: 0.3, PP: 0.4, sil: 0.2 },\n  SS:  { sil: 0.2, aa: 0.3, CH: 0.6 },\n};\n\n/**\n * Get the transition weight between two visemes.\n * @param {string} from\n * @param {string} to\n * @returns {number} Weight 0..1 (higher = more blending).\n */\nexport function getTransitionWeight(from, to) {\n  return TRANSITION_WEIGHTS[from]?.[to] ?? 0.35; // sensible default\n}\n\n// ─── Mouth shape parameters for procedural rendering ────────────────────────\n// Each viseme maps to normalized parameters: openness, width, roundness\n\n/** @type {Object<string, {open: number, width: number, round: number}>} */\nexport const VISEME_SHAPES = {\n  sil: { open: 0.00, width: 0.50, round: 0.0 },\n  PP:  { open: 0.00, width: 0.40, round: 0.0 },\n  FF:  { open: 0.05, width: 0.55, round: 0.0 },\n  TH:  { open: 0.10, width: 0.50, round: 0.0 },\n  DD:  { open: 0.20, width: 0.50, round: 0.0 },\n  kk:  { open: 0.25, width: 0.45, round: 0.0 },\n  CH:  { open: 0.15, width: 0.35, round: 0.6 },\n  SS:  { open: 0.05, width: 0.60, round: 0.0 },\n  nn:  { open: 0.15, width: 0.50, round: 0.0 },\n  RR:  { open: 0.20, width: 0.40, round: 0.4 },\n  aa:  { open: 0.90, width: 0.60, round: 0.0 },\n  E:   { open: 0.50, width: 0.65, round: 0.0 },\n  I:   { open: 0.25, width: 0.70, round: 0.0 },\n  O:   { open: 0.60, width: 0.40, round: 0.8 },\n  U:   { open: 0.20, width: 0.30, round: 0.9 },\n};\n\n/**\n * Get interpolated mouth shape between two visemes.\n * @param {string} fromViseme\n * @param {string} toViseme\n * @param {number} t - Interpolation factor [0, 1].\n * @returns {{open: number, width: number, round: number}}\n */\nexport function interpolateShapes(fromViseme, toViseme, t) {\n  const a = VISEME_SHAPES[fromViseme] || VISEME_SHAPES.sil;\n  const b = VISEME_SHAPES[toViseme] || VISEME_SHAPES.sil;\n  const clampT = Math.max(0, Math.min(1, t));\n  return {\n    open:  a.open  + (b.open  - a.open)  * clampT,\n    width: a.width + (b.width - a.width) * clampT,\n    round: a.round + (b.round - a.round) * clampT,\n  };\n}\n","/**\n * FrequencyAnalyzer — Real-time viseme detection from audio frequency analysis.\n *\n * Uses AnalyserNode FFT data to classify audio frames into viseme categories\n * based on frequency band energy distribution, amplitude, and zero-crossing rate.\n *\n * Detection pipeline:\n *   1. Silence gate → sil\n *   2. Band energy extraction (5 bands)\n *   3. Feature classification (sibilant, fricative, vowel, plosive, nasal)\n *   4. Viseme selection with confidence scoring\n *   5. Temporal smoothing (EMA + holdoff)\n *\n * @module FrequencyAnalyzer\n */\n\nimport {\n  calculateRMS,\n  extractBandEnergies,\n  smoothValue,\n  clamp,\n} from '../utils/audio-utils.js';\nimport {\n  EXTENDED_TO_SIMPLE,\n  VISEME_SHAPES,\n  getTransitionWeight,\n} from '../core/visemes.js';\n\n/** Default analyzer configuration. */\nconst DEFAULTS = {\n  fftSize: 256,\n  silenceThreshold: 0.015,\n  smoothingFactor: 0.35,\n  holdFrames: 2,           // Minimum frames to hold a viseme before switching\n  intensitySmoothing: 0.2,\n  energySmoothing: 0.5,    // AnalyserNode smoothingTimeConstant\n};\n\nexport class FrequencyAnalyzer {\n  /**\n   * @param {AnalyserNode} analyserNode - Connected AnalyserNode.\n   * @param {number} sampleRate - AudioContext sample rate.\n   * @param {Object} [options]\n   */\n  constructor(analyserNode, sampleRate, options = {}) {\n    this.analyser = analyserNode;\n    this.sampleRate = sampleRate;\n    this.opts = { ...DEFAULTS, ...options };\n\n    // Configure analyser\n    this.analyser.fftSize = this.opts.fftSize;\n    this.analyser.smoothingTimeConstant = this.opts.energySmoothing;\n\n    // Analysis buffers\n    this.timeDomainData = new Uint8Array(this.analyser.fftSize);\n    this.frequencyData = new Uint8Array(this.analyser.frequencyBinCount);\n\n    // State\n    this._currentViseme = 'sil';\n    this._currentIntensity = 0;\n    this._holdCounter = 0;\n    this._smoothedAmplitude = 0;\n    this._smoothedBands = { sub: 0, low: 0, mid: 0, high: 0, veryHigh: 0 };\n    this._previousViseme = 'sil';\n    this._transitionProgress = 1; // 0..1 blend between prev → current\n    this._frameCount = 0;\n  }\n\n  /**\n   * Analyze the current audio frame and return viseme data.\n   * Call this once per animation frame (~60fps) or at your desired analysis rate.\n   *\n   * @returns {VisemeFrame}\n   */\n  analyze() {\n    this._frameCount++;\n\n    // ── Gather raw data ──────────────────────────────────────────\n    this.analyser.getByteTimeDomainData(this.timeDomainData);\n    this.analyser.getByteFrequencyData(this.frequencyData);\n\n    const rawAmplitude = calculateRMS(this.timeDomainData, true);\n    this._smoothedAmplitude = smoothValue(\n      this._smoothedAmplitude,\n      rawAmplitude,\n      this.opts.smoothingFactor\n    );\n\n    // ── Band energies ────────────────────────────────────────────\n    const rawBands = extractBandEnergies(this.frequencyData, this.sampleRate);\n    for (const key of Object.keys(rawBands)) {\n      this._smoothedBands[key] = smoothValue(\n        this._smoothedBands[key] || 0,\n        rawBands[key],\n        this.opts.smoothingFactor\n      );\n    }\n    const bands = this._smoothedBands;\n\n    // ── Silence gate ─────────────────────────────────────────────\n    if (this._smoothedAmplitude < this.opts.silenceThreshold) {\n      return this._emitViseme('sil', 0, bands);\n    }\n\n    // ── Feature extraction ───────────────────────────────────────\n    const intensity = clamp(this._smoothedAmplitude * 3, 0, 1);\n    const { viseme, confidence } = this._classifyViseme(bands, intensity);\n\n    // ── Hold-off: prevent rapid flickering ───────────────────────\n    if (viseme !== this._currentViseme) {\n      this._holdCounter++;\n      if (this._holdCounter < this.opts.holdFrames) {\n        // Keep current viseme during hold period\n        return this._emitViseme(this._currentViseme, intensity, bands);\n      }\n      this._holdCounter = 0;\n    } else {\n      this._holdCounter = 0;\n    }\n\n    return this._emitViseme(viseme, intensity, bands, confidence);\n  }\n\n  /**\n   * Classify the current audio frame into a viseme.\n   * @private\n   */\n  _classifyViseme(bands, intensity) {\n    const { sub, low, mid, high, veryHigh } = bands;\n    const totalEnergy = sub + low + mid + high + veryHigh;\n\n    if (totalEnergy < 0.01) {\n      return { viseme: 'sil', confidence: 0.9 };\n    }\n\n    // ── Sibilants (S, Z, SH) → heavy high-frequency ─────────────\n    const sibilantScore = (high + veryHigh) / (totalEnergy + 0.001);\n    if (sibilantScore > 0.55 && high > 0.15) {\n      if (veryHigh > high * 0.8) {\n        return { viseme: 'SS', confidence: sibilantScore };\n      }\n      return { viseme: 'CH', confidence: sibilantScore * 0.85 };\n    }\n\n    // ── Fricatives (F, V, TH) → mid-high energy ─────────────────\n    const fricativeScore = (mid + high) / (totalEnergy + 0.001);\n    if (fricativeScore > 0.5 && high > 0.1 && low < 0.15) {\n      return { viseme: 'FF', confidence: fricativeScore * 0.8 };\n    }\n\n    // ── Plosives (P, B, T, D) → sudden energy burst ─────────────\n    // Detected by high intensity with relatively flat spectrum\n    const flatness = 1 - Math.abs(high - low) / (totalEnergy + 0.001);\n    if (intensity > 0.6 && flatness > 0.7 && this._smoothedAmplitude > 0.08) {\n      if (low > mid) {\n        return { viseme: 'PP', confidence: 0.6 };\n      }\n      return { viseme: 'DD', confidence: 0.6 };\n    }\n\n    // ── Nasals (M, N, NG) → strong sub/low, weak mid/high ───────\n    if (sub > 0.2 && low > 0.15 && high < 0.08 && mid < low * 0.7) {\n      return { viseme: 'nn', confidence: 0.65 };\n    }\n\n    // ── Vowels — classified by formant-like band patterns ────────\n    // This is approximate; real formant tracking needs higher FFT resolution\n\n    // Wide open (AA/AH): strong low+mid, moderate sub\n    if (low > 0.2 && mid > 0.15 && intensity > 0.5) {\n      return { viseme: 'aa', confidence: 0.7 };\n    }\n\n    // EH/AE: mid stronger than low\n    if (mid > low && mid > 0.15 && intensity > 0.3) {\n      return { viseme: 'E', confidence: 0.65 };\n    }\n\n    // OH/AO: sub+low dominant, some mid\n    if (sub > mid && low > mid && intensity > 0.3) {\n      return { viseme: 'O', confidence: 0.6 };\n    }\n\n    // IH/IY: higher-mid energy, narrower mouth\n    if (mid > 0.1 && high > low * 0.5 && intensity > 0.2) {\n      return { viseme: 'I', confidence: 0.55 };\n    }\n\n    // UW/OW: strong sub, weak everything else\n    if (sub > 0.15 && high < 0.05) {\n      return { viseme: 'U', confidence: 0.5 };\n    }\n\n    // ── Default: amplitude-based fallback ────────────────────────\n    if (intensity > 0.5) return { viseme: 'aa', confidence: 0.4 };\n    if (intensity > 0.3) return { viseme: 'E', confidence: 0.35 };\n    if (intensity > 0.15) return { viseme: 'I', confidence: 0.3 };\n    return { viseme: 'sil', confidence: 0.5 };\n  }\n\n  /**\n   * Build and return the viseme frame, updating transitions.\n   * @private\n   */\n  _emitViseme(viseme, intensity, bands, confidence = 0.5) {\n    // Track transitions\n    if (viseme !== this._currentViseme) {\n      this._previousViseme = this._currentViseme;\n      this._currentViseme = viseme;\n      this._transitionProgress = 0;\n    } else {\n      // Advance transition\n      const weight = getTransitionWeight(this._previousViseme, this._currentViseme);\n      this._transitionProgress = Math.min(1, this._transitionProgress + (1 - weight) * 0.3);\n    }\n\n    // Smooth intensity\n    this._currentIntensity = smoothValue(\n      this._currentIntensity,\n      intensity,\n      this.opts.intensitySmoothing\n    );\n\n    // Get mouth shape parameters (interpolated during transition)\n    const prevShape = VISEME_SHAPES[this._previousViseme] || VISEME_SHAPES.sil;\n    const currShape = VISEME_SHAPES[this._currentViseme] || VISEME_SHAPES.sil;\n    const t = this._transitionProgress;\n\n    return {\n      viseme: this._currentViseme,\n      simpleViseme: EXTENDED_TO_SIMPLE[this._currentViseme] || 'A',\n      intensity: this._currentIntensity,\n      confidence,\n      amplitude: this._smoothedAmplitude,\n      bands: { ...this._smoothedBands },\n      shape: {\n        open:  prevShape.open  + (currShape.open  - prevShape.open)  * t,\n        width: prevShape.width + (currShape.width - prevShape.width) * t,\n        round: prevShape.round + (currShape.round - prevShape.round) * t,\n      },\n      transition: {\n        from: this._previousViseme,\n        to: this._currentViseme,\n        progress: this._transitionProgress,\n      },\n      frame: this._frameCount,\n    };\n  }\n\n  /** Reset analyzer state. */\n  reset() {\n    this._currentViseme = 'sil';\n    this._currentIntensity = 0;\n    this._holdCounter = 0;\n    this._smoothedAmplitude = 0;\n    this._smoothedBands = { sub: 0, low: 0, mid: 0, high: 0, veryHigh: 0 };\n    this._previousViseme = 'sil';\n    this._transitionProgress = 1;\n    this._frameCount = 0;\n  }\n}\n\n/**\n * @typedef {Object} VisemeFrame\n * @property {string} viseme - Extended viseme key.\n * @property {string} simpleViseme - Simple (A-F) viseme key.\n * @property {number} intensity - Smoothed speech intensity [0, 1].\n * @property {number} confidence - Classification confidence [0, 1].\n * @property {number} amplitude - Smoothed RMS amplitude [0, 1].\n * @property {Object} bands - Frequency band energies.\n * @property {Object} shape - Interpolated mouth shape {open, width, round}.\n * @property {Object} transition - Transition state {from, to, progress}.\n * @property {number} frame - Analysis frame counter.\n */\n","/**\n * LipSyncEngine — Main orchestrator for streaming lip-sync.\n *\n * Manages the full audio pipeline:\n *   AudioSource → AudioWorklet → AnalyserNode → FrequencyAnalyzer → Events\n *\n * Supports three input modes:\n *   1. Streaming PCM chunks (from TTS APIs like OpenAI Realtime, ElevenLabs)\n *   2. MediaStream (microphone, WebRTC)\n *   3. HTMLMediaElement (audio/video element)\n *\n * @module LipSyncEngine\n *\n * @example\n *   import { LipSyncEngine } from '@beer-digital/lipsync-engine';\n *\n *   const engine = new LipSyncEngine({ sampleRate: 24000 });\n *   await engine.init();\n *\n *   engine.on('viseme', (frame) => {\n *     updateAvatar(frame.viseme, frame.intensity, frame.shape);\n *   });\n *\n *   // Feed PCM chunks from TTS\n *   ws.onmessage = (e) => {\n *     const data = JSON.parse(e.data);\n *     if (data.type === 'audio') {\n *       engine.feedAudio(base64ToInt16(data.audio));\n *     }\n *   };\n */\n\nimport { EventEmitter } from '../utils/EventEmitter.js';\nimport { FrequencyAnalyzer } from '../analyzers/FrequencyAnalyzer.js';\nimport { int16ToFloat32, resample } from '../utils/audio-utils.js';\n\n/** @type {Object} Default engine options. */\nconst DEFAULTS = {\n  // Audio pipeline\n  sampleRate: 24000,           // Expected input sample rate\n  fftSize: 256,                // FFT window size (power of 2)\n  analyserSmoothing: 0.5,      // AnalyserNode smoothingTimeConstant\n\n  // Viseme detection\n  silenceThreshold: 0.015,     // RMS below this = silence\n  smoothingFactor: 0.35,       // Viseme transition smoothing (0-1)\n  holdFrames: 2,               // Min frames before viseme switch\n  intensitySmoothing: 0.2,     // Intensity EMA factor\n\n  // Playback\n  volume: 1.0,\n  startThresholdMs: 50,        // Buffer ms before auto-play\n  bufferSeconds: 5,            // Ring buffer capacity\n\n  // Analysis timing\n  analysisMode: 'raf',         // 'raf' (requestAnimationFrame) or 'interval'\n  analysisIntervalMs: 16,      // Only used when analysisMode = 'interval'\n\n  // Worklet\n  workletUrl: null,            // Custom worklet URL (auto-detected if null)\n  disablePlayback: false,      // If true, analyze only (no audio output)\n};\n\nexport class LipSyncEngine extends EventEmitter {\n  /**\n   * @param {Partial<typeof DEFAULTS>} options\n   */\n  constructor(options = {}) {\n    super();\n    this.opts = { ...DEFAULTS, ...options };\n\n    /** @type {AudioContext|null} */\n    this.audioContext = null;\n\n    /** @type {AudioWorkletNode|null} */\n    this.workletNode = null;\n\n    /** @type {AnalyserNode|null} */\n    this.analyserNode = null;\n\n    /** @type {GainNode|null} */\n    this.gainNode = null;\n\n    /** @type {FrequencyAnalyzer|null} */\n    this.analyzer = null;\n\n    /** @type {MediaStreamAudioSourceNode|null} */\n    this._mediaSource = null;\n\n    /** @type {MediaElementAudioSourceNode|null} */\n    this._elementSource = null;\n\n    // State\n    this._initialized = false;\n    this._analyzing = false;\n    this._animFrameId = null;\n    this._intervalId = null;\n    this._inputMode = null; // 'stream' | 'media' | 'element'\n    this._playbackTimeMs = 0;\n    this._bufferLevel = 0;\n    this._destroyed = false;\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  INITIALIZATION\n  // ════════════════════════════════════════════════════════════════\n\n  /**\n   * Initialize the audio pipeline. Must be called after a user gesture (browser policy).\n   * @param {AudioContext} [existingContext] - Optionally reuse an existing AudioContext.\n   * @returns {Promise<void>}\n   */\n  async init(existingContext) {\n    if (this._initialized) return;\n    if (this._destroyed) throw new Error('Engine has been destroyed');\n\n    // Create or reuse AudioContext\n    this.audioContext = existingContext || new AudioContext({\n      sampleRate: this.opts.sampleRate,\n    });\n\n    // Resume if suspended (browser autoplay policy)\n    if (this.audioContext.state === 'suspended') {\n      await this.audioContext.resume();\n    }\n\n    // Load AudioWorklet\n    const workletUrl = this.opts.workletUrl || this._resolveWorkletUrl();\n    await this.audioContext.audioWorklet.addModule(workletUrl);\n\n    // Create worklet node\n    this.workletNode = new AudioWorkletNode(\n      this.audioContext,\n      'streaming-processor',\n      {\n        processorOptions: {\n          sampleRate: this.opts.sampleRate,\n          bufferSeconds: this.opts.bufferSeconds,\n          startThresholdMs: this.opts.startThresholdMs,\n        },\n      }\n    );\n\n    // Create analyser\n    this.analyserNode = this.audioContext.createAnalyser();\n    this.analyserNode.fftSize = this.opts.fftSize;\n    this.analyserNode.smoothingTimeConstant = this.opts.analyserSmoothing;\n\n    // Create gain node\n    this.gainNode = this.audioContext.createGain();\n    this.gainNode.gain.value = this.opts.volume;\n\n    // Connect pipeline: Worklet → Analyser → Gain → Destination\n    this.workletNode.connect(this.analyserNode);\n    if (!this.opts.disablePlayback) {\n      this.analyserNode.connect(this.gainNode);\n      this.gainNode.connect(this.audioContext.destination);\n    }\n\n    // Create frequency analyzer\n    this.analyzer = new FrequencyAnalyzer(\n      this.analyserNode,\n      this.audioContext.sampleRate,\n      {\n        fftSize: this.opts.fftSize,\n        silenceThreshold: this.opts.silenceThreshold,\n        smoothingFactor: this.opts.smoothingFactor,\n        holdFrames: this.opts.holdFrames,\n        intensitySmoothing: this.opts.intensitySmoothing,\n      }\n    );\n\n    // Listen for worklet messages\n    this.workletNode.port.onmessage = (e) => this._onWorkletMessage(e.data);\n\n    this._initialized = true;\n    this._inputMode = 'stream';\n    this.emit('initialized');\n  }\n\n  /**\n   * Try to resolve the worklet URL automatically.\n   * @private\n   */\n  _resolveWorkletUrl() {\n    // Try common locations\n    const candidates = [\n      './streaming-processor.js',\n      './worklet/streaming-processor.js',\n      './dist/worklet/streaming-processor.js',\n      '/streaming-processor.js',\n    ];\n\n    // If running from npm package, try node_modules path\n    // The consumer should ideally provide workletUrl explicitly\n    return candidates[0];\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  INPUT SOURCES\n  // ════════════════════════════════════════════════════════════════\n\n  /**\n   * Feed PCM audio chunks for streaming playback + analysis.\n   * This is the primary method for TTS API integration.\n   *\n   * @param {Int16Array|Float32Array|ArrayBuffer} samples - Audio samples.\n   * @param {number} [inputSampleRate] - Override sample rate for this chunk.\n   */\n  feedAudio(samples, inputSampleRate) {\n    this._ensureInitialized();\n\n    let float32;\n\n    if (samples instanceof Int16Array) {\n      float32 = int16ToFloat32(samples);\n    } else if (samples instanceof Float32Array) {\n      float32 = samples;\n    } else if (samples instanceof ArrayBuffer) {\n      // Assume Int16 PCM\n      float32 = int16ToFloat32(new Int16Array(samples));\n    } else if (ArrayBuffer.isView(samples)) {\n      float32 = int16ToFloat32(new Int16Array(samples.buffer));\n    } else {\n      throw new TypeError('feedAudio expects Int16Array, Float32Array, or ArrayBuffer');\n    }\n\n    // Resample if needed\n    const srcRate = inputSampleRate || this.opts.sampleRate;\n    if (srcRate !== this.audioContext.sampleRate) {\n      float32 = resample(float32, srcRate, this.audioContext.sampleRate);\n    }\n\n    // Send to worklet\n    this.workletNode.port.postMessage(\n      { type: 'audio', samples: float32 },\n      [float32.buffer] // Transfer ownership for zero-copy\n    );\n  }\n\n  /**\n   * Attach a MediaStream (e.g., microphone) for analysis.\n   * Audio is analyzed but NOT played back (to avoid feedback).\n   *\n   * @param {MediaStream} stream\n   */\n  attachStream(stream) {\n    this._ensureInitialized();\n    this._disconnectSources();\n\n    this._mediaSource = this.audioContext.createMediaStreamSource(stream);\n    this._mediaSource.connect(this.analyserNode);\n    // Don't connect to destination (feedback prevention)\n\n    this._inputMode = 'media';\n    this.emit('sourceAttached', { type: 'stream' });\n  }\n\n  /**\n   * Attach an HTML audio/video element for analysis.\n   *\n   * @param {HTMLMediaElement} element\n   */\n  attachElement(element) {\n    this._ensureInitialized();\n    this._disconnectSources();\n\n    this._elementSource = this.audioContext.createMediaElementSource(element);\n    this._elementSource.connect(this.analyserNode);\n    this.analyserNode.connect(this.audioContext.destination);\n\n    this._inputMode = 'element';\n    this.emit('sourceAttached', { type: 'element' });\n  }\n\n  /**\n   * Disconnect any attached media sources.\n   * @private\n   */\n  _disconnectSources() {\n    if (this._mediaSource) {\n      try { this._mediaSource.disconnect(); } catch {}\n      this._mediaSource = null;\n    }\n    if (this._elementSource) {\n      try { this._elementSource.disconnect(); } catch {}\n      this._elementSource = null;\n    }\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  ANALYSIS LOOP\n  // ════════════════════════════════════════════════════════════════\n\n  /**\n   * Start the viseme analysis loop.\n   * Emits 'viseme' events at the configured rate.\n   */\n  startAnalysis() {\n    if (this._analyzing) return;\n    this._ensureInitialized();\n    this._analyzing = true;\n\n    if (this.opts.analysisMode === 'raf') {\n      this._startRAFLoop();\n    } else {\n      this._startIntervalLoop();\n    }\n\n    this.emit('analysisStarted');\n  }\n\n  /** Stop the viseme analysis loop. */\n  stopAnalysis() {\n    this._analyzing = false;\n\n    if (this._animFrameId !== null) {\n      cancelAnimationFrame(this._animFrameId);\n      this._animFrameId = null;\n    }\n    if (this._intervalId !== null) {\n      clearInterval(this._intervalId);\n      this._intervalId = null;\n    }\n\n    this.emit('analysisStopped');\n  }\n\n  /** @private */\n  _startRAFLoop() {\n    const tick = () => {\n      if (!this._analyzing) return;\n      this._analyzeFrame();\n      this._animFrameId = requestAnimationFrame(tick);\n    };\n    this._animFrameId = requestAnimationFrame(tick);\n  }\n\n  /** @private */\n  _startIntervalLoop() {\n    this._intervalId = setInterval(() => {\n      if (!this._analyzing) return;\n      this._analyzeFrame();\n    }, this.opts.analysisIntervalMs);\n  }\n\n  /** @private */\n  _analyzeFrame() {\n    const frame = this.analyzer.analyze();\n    frame.timeMs = this._playbackTimeMs;\n    frame.bufferLevel = this._bufferLevel;\n    this.emit('viseme', frame);\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  WORKLET COMMUNICATION\n  // ════════════════════════════════════════════════════════════════\n\n  /** @private */\n  _onWorkletMessage(data) {\n    switch (data.type) {\n      case 'position':\n        this._playbackTimeMs = data.timeMs;\n        this._bufferLevel = data.bufferLevel;\n        this.emit('position', {\n          timeMs: data.timeMs,\n          bufferLevel: data.bufferLevel,\n          bufferMs: data.bufferMs,\n          isPlaying: data.isPlaying,\n        });\n        break;\n\n      case 'playbackStarted':\n        this.emit('playbackStarted');\n        break;\n\n      case 'playbackEnded':\n        this.emit('playbackEnded');\n        break;\n\n      case 'bufferUnderrun':\n        this.emit('bufferUnderrun', { timeMs: data.timeMs });\n        break;\n\n      case 'bufferOverflow':\n        this.emit('bufferOverflow', { dropped: data.dropped });\n        break;\n\n      case 'ready':\n        this.emit('workletReady');\n        break;\n    }\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  CONTROLS\n  // ════════════════════════════════════════════════════════════════\n\n  /**\n   * Set playback volume.\n   * @param {number} value - Volume [0, 1].\n   */\n  setVolume(value) {\n    const v = Math.max(0, Math.min(1, value));\n    if (this.gainNode) {\n      this.gainNode.gain.setTargetAtTime(v, this.audioContext.currentTime, 0.02);\n    }\n    this.workletNode?.port.postMessage({ type: 'setVolume', value: v });\n  }\n\n  /** Clear the audio buffer (stops playback of buffered audio). */\n  clearBuffer() {\n    this.workletNode?.port.postMessage({ type: 'clear' });\n  }\n\n  /** Start playback (if paused). */\n  play() {\n    this.workletNode?.port.postMessage({ type: 'start' });\n  }\n\n  /** Pause playback. */\n  pause() {\n    this.workletNode?.port.postMessage({ type: 'stop' });\n  }\n\n  /** Reset all state (buffer, position, analyzer). */\n  reset() {\n    this.workletNode?.port.postMessage({ type: 'reset' });\n    this.analyzer?.reset();\n    this._playbackTimeMs = 0;\n    this._bufferLevel = 0;\n    this.emit('reset');\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  STATE QUERIES\n  // ════════════════════════════════════════════════════════════════\n\n  /** Whether the engine has been initialized. */\n  get initialized() { return this._initialized; }\n\n  /** Whether analysis is currently running. */\n  get analyzing() { return this._analyzing; }\n\n  /** Current playback position in milliseconds. */\n  get playbackTimeMs() { return this._playbackTimeMs; }\n\n  /** Current buffer fill level (0..1). */\n  get bufferLevel() { return this._bufferLevel; }\n\n  /** Current input mode: 'stream', 'media', or 'element'. */\n  get inputMode() { return this._inputMode; }\n\n  /**\n   * Get a snapshot of current engine state.\n   * @returns {Object}\n   */\n  getState() {\n    return {\n      initialized: this._initialized,\n      analyzing: this._analyzing,\n      inputMode: this._inputMode,\n      playbackTimeMs: this._playbackTimeMs,\n      bufferLevel: this._bufferLevel,\n      sampleRate: this.audioContext?.sampleRate,\n      volume: this.gainNode?.gain.value,\n    };\n  }\n\n  // ════════════════════════════════════════════════════════════════\n  //  LIFECYCLE\n  // ════════════════════════════════════════════════════════════════\n\n  /**\n   * Destroy the engine and release all resources.\n   */\n  destroy() {\n    if (this._destroyed) return;\n    this._destroyed = true;\n\n    this.stopAnalysis();\n    this._disconnectSources();\n\n    try { this.workletNode?.disconnect(); } catch {}\n    try { this.analyserNode?.disconnect(); } catch {}\n    try { this.gainNode?.disconnect(); } catch {}\n\n    // Only close context if we created it\n    if (this.audioContext?.state !== 'closed') {\n      this.audioContext?.close().catch(() => {});\n    }\n\n    this.workletNode = null;\n    this.analyserNode = null;\n    this.gainNode = null;\n    this.analyzer = null;\n    this.audioContext = null;\n    this._initialized = false;\n\n    this.removeAllListeners();\n    this.emit('destroyed');\n  }\n\n  /** @private */\n  _ensureInitialized() {\n    if (!this._initialized) {\n      throw new Error('LipSyncEngine not initialized. Call init() first.');\n    }\n  }\n}\n","/**\n * CSSClassRenderer — Applies CSS classes to an element based on viseme state.\n *\n * Perfect for CSS sprite animations, Lottie triggers, or any framework\n * where you toggle classes/data-attributes to change mouth appearance.\n *\n * @module CSSClassRenderer\n *\n * @example\n *   // CSS:\n *   // .mouth[data-viseme=\"sil\"] { background-position: 0 0; }\n *   // .mouth[data-viseme=\"aa\"]  { background-position: -128px 0; }\n *\n *   const renderer = new CSSClassRenderer(mouthElement, {\n *     attribute: 'data-viseme',    // Set data attribute\n *     classPrefix: 'mouth-',       // Also toggle class: mouth-sil, mouth-aa, etc.\n *     useSimpleVisemes: true,      // Use A-F instead of extended set\n *   });\n *\n *   engine.on('viseme', (frame) => renderer.render(frame));\n */\n\nexport class CSSClassRenderer {\n  /**\n   * @param {HTMLElement} element - Target DOM element.\n   * @param {Object} [options]\n   * @param {string} [options.attribute='data-viseme'] - Data attribute to set.\n   * @param {string} [options.classPrefix=''] - If set, toggles CSS classes.\n   * @param {boolean} [options.useSimpleVisemes=false] - Use simple (A-F) viseme keys.\n   * @param {string} [options.intensityAttribute='data-intensity'] - Attribute for intensity.\n   * @param {boolean} [options.setIntensity=true] - Whether to set intensity attribute.\n   * @param {Object<string, string>} [options.visemeClassMap] - Custom viseme → class mapping.\n   */\n  constructor(element, options = {}) {\n    this.element = element;\n    this.opts = {\n      attribute: 'data-viseme',\n      classPrefix: '',\n      useSimpleVisemes: false,\n      intensityAttribute: 'data-intensity',\n      setIntensity: true,\n      visemeClassMap: null,\n      ...options,\n    };\n\n    this._currentClass = null;\n    this._currentViseme = null;\n  }\n\n  /**\n   * Apply viseme state to the element.\n   * @param {import('../analyzers/FrequencyAnalyzer.js').VisemeFrame} frame\n   */\n  render(frame) {\n    const viseme = this.opts.useSimpleVisemes ? frame.simpleViseme : frame.viseme;\n\n    if (viseme !== this._currentViseme) {\n      // Update attribute\n      this.element.setAttribute(this.opts.attribute, viseme);\n\n      // Update CSS class\n      if (this.opts.classPrefix) {\n        if (this._currentClass) {\n          this.element.classList.remove(this._currentClass);\n        }\n        const mapped = this.opts.visemeClassMap?.[viseme];\n        this._currentClass = mapped || `${this.opts.classPrefix}${viseme}`;\n        this.element.classList.add(this._currentClass);\n      }\n\n      this._currentViseme = viseme;\n    }\n\n    // Update intensity\n    if (this.opts.setIntensity) {\n      const level = Math.round(frame.intensity * 100);\n      this.element.setAttribute(this.opts.intensityAttribute, level);\n      this.element.style.setProperty('--lip-intensity', frame.intensity);\n      this.element.style.setProperty('--lip-open', frame.shape?.open ?? 0);\n      this.element.style.setProperty('--lip-width', frame.shape?.width ?? 0.5);\n      this.element.style.setProperty('--lip-round', frame.shape?.round ?? 0);\n    }\n  }\n\n  /** Remove classes and attributes from element. */\n  destroy() {\n    if (this._currentClass) {\n      this.element.classList.remove(this._currentClass);\n    }\n    this.element.removeAttribute(this.opts.attribute);\n    this.element.removeAttribute(this.opts.intensityAttribute);\n    this._currentViseme = null;\n  }\n}\n","/**\n * CanvasRenderer — Renders lip-sync visemes using a sprite sheet on Canvas 2D.\n *\n * Expects a sprite sheet image where each viseme is a fixed-size frame\n * arranged in a grid or strip.\n *\n * @module CanvasRenderer\n *\n * @example\n *   const renderer = new CanvasRenderer(canvas, {\n *     spriteSheet: mouthSprites,       // Image or URL\n *     frameWidth: 128,\n *     frameHeight: 128,\n *     visemeMap: { sil: 0, PP: 1, FF: 2, ... }\n *   });\n *\n *   engine.on('viseme', (frame) => renderer.render(frame));\n */\n\nexport class CanvasRenderer {\n  /**\n   * @param {HTMLCanvasElement} canvas\n   * @param {Object} options\n   * @param {HTMLImageElement|string} options.spriteSheet - Sprite sheet image or URL.\n   * @param {number} options.frameWidth - Width of each frame in the sprite sheet.\n   * @param {number} options.frameHeight - Height of each frame.\n   * @param {Object<string, number>} options.visemeMap - Maps viseme keys to frame indices.\n   * @param {number} [options.columns] - Columns in sprite sheet (auto-calculated if omitted).\n   * @param {number} [options.offsetX=0] - X offset for rendering on canvas.\n   * @param {number} [options.offsetY=0] - Y offset for rendering on canvas.\n   * @param {number} [options.scale=1] - Render scale.\n   * @param {boolean} [options.clearBeforeRender=true]\n   */\n  constructor(canvas, options) {\n    this.canvas = canvas;\n    this.ctx = canvas.getContext('2d');\n    this.opts = {\n      offsetX: 0,\n      offsetY: 0,\n      scale: 1,\n      clearBeforeRender: true,\n      ...options,\n    };\n\n    /** @type {HTMLImageElement|null} */\n    this.spriteSheet = null;\n    this._ready = false;\n    this._currentFrame = 0;\n    this._targetFrame = 0;\n    this._blendProgress = 1;\n\n    this._loadSpriteSheet(options.spriteSheet);\n  }\n\n  /** @private */\n  async _loadSpriteSheet(source) {\n    if (source instanceof HTMLImageElement) {\n      this.spriteSheet = source;\n      if (source.complete) {\n        this._ready = true;\n      } else {\n        await new Promise((resolve) => {\n          source.onload = resolve;\n        });\n        this._ready = true;\n      }\n    } else if (typeof source === 'string') {\n      this.spriteSheet = new Image();\n      this.spriteSheet.src = source;\n      await new Promise((resolve, reject) => {\n        this.spriteSheet.onload = resolve;\n        this.spriteSheet.onerror = reject;\n      });\n      this._ready = true;\n    }\n\n    // Auto-detect columns\n    if (!this.opts.columns && this.spriteSheet) {\n      this.opts.columns = Math.floor(\n        this.spriteSheet.naturalWidth / this.opts.frameWidth\n      );\n    }\n  }\n\n  /**\n   * Render a viseme frame to the canvas.\n   * @param {import('../analyzers/FrequencyAnalyzer.js').VisemeFrame} frame\n   */\n  render(frame) {\n    if (!this._ready || !this.spriteSheet) return;\n\n    const frameIndex = this.opts.visemeMap[frame.viseme] ?? this.opts.visemeMap.sil ?? 0;\n    const cols = this.opts.columns || 1;\n    const row = Math.floor(frameIndex / cols);\n    const col = frameIndex % cols;\n\n    const sx = col * this.opts.frameWidth;\n    const sy = row * this.opts.frameHeight;\n\n    if (this.opts.clearBeforeRender) {\n      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n    }\n\n    const dw = this.opts.frameWidth * this.opts.scale;\n    const dh = this.opts.frameHeight * this.opts.scale;\n\n    this.ctx.drawImage(\n      this.spriteSheet,\n      sx, sy, this.opts.frameWidth, this.opts.frameHeight,\n      this.opts.offsetX, this.opts.offsetY, dw, dh\n    );\n  }\n\n  /** Destroy and release canvas reference. */\n  destroy() {\n    this.spriteSheet = null;\n    this._ready = false;\n  }\n}\n","/**\n * Lock-free ring buffer for Float32 audio samples.\n * Designed for use inside an AudioWorkletProcessor where\n * allocations must be avoided in the process() hot path.\n *\n * @module RingBuffer\n */\nexport class RingBuffer {\n  /**\n   * @param {number} capacity - Maximum number of Float32 samples.\n   */\n  constructor(capacity) {\n    /** @type {Float32Array} */\n    this.buffer = new Float32Array(capacity);\n    /** @type {number} */\n    this.capacity = capacity;\n    /** @type {number} */\n    this.readPtr = 0;\n    /** @type {number} */\n    this.writePtr = 0;\n    /** @type {number} */\n    this.available = 0;\n  }\n\n  /** Number of samples that can be read. */\n  get length() {\n    return this.available;\n  }\n\n  /** Number of samples that can be written before overflow. */\n  get free() {\n    return this.capacity - this.available;\n  }\n\n  /** Whether the buffer is completely empty. */\n  get empty() {\n    return this.available === 0;\n  }\n\n  /** Whether the buffer is completely full. */\n  get full() {\n    return this.available === this.capacity;\n  }\n\n  /** Fill level as a fraction 0..1. */\n  get level() {\n    return this.available / this.capacity;\n  }\n\n  /**\n   * Write samples into the buffer.\n   * @param {Float32Array} samples\n   * @returns {number} Number of samples actually written.\n   */\n  write(samples) {\n    const toWrite = Math.min(samples.length, this.free);\n    for (let i = 0; i < toWrite; i++) {\n      this.buffer[this.writePtr] = samples[i];\n      this.writePtr = (this.writePtr + 1) % this.capacity;\n    }\n    this.available += toWrite;\n    return toWrite;\n  }\n\n  /**\n   * Write samples, overwriting oldest data if full.\n   * @param {Float32Array} samples\n   * @returns {number} Number of samples overwritten.\n   */\n  writeOverflow(samples) {\n    let overwritten = 0;\n    for (let i = 0; i < samples.length; i++) {\n      if (this.available >= this.capacity) {\n        // Overwrite oldest\n        this.readPtr = (this.readPtr + 1) % this.capacity;\n        overwritten++;\n      } else {\n        this.available++;\n      }\n      this.buffer[this.writePtr] = samples[i];\n      this.writePtr = (this.writePtr + 1) % this.capacity;\n    }\n    return overwritten;\n  }\n\n  /**\n   * Read samples from the buffer into the target array.\n   * @param {Float32Array} target - Destination array.\n   * @param {number} [offset=0] - Starting offset in target.\n   * @param {number} [count] - Samples to read (defaults to target.length - offset).\n   * @returns {number} Number of samples actually read.\n   */\n  read(target, offset = 0, count) {\n    const toRead = Math.min(count ?? (target.length - offset), this.available);\n    for (let i = 0; i < toRead; i++) {\n      target[offset + i] = this.buffer[this.readPtr];\n      this.readPtr = (this.readPtr + 1) % this.capacity;\n    }\n    this.available -= toRead;\n    return toRead;\n  }\n\n  /**\n   * Read a single sample. Returns 0 if empty.\n   * @returns {number}\n   */\n  readOne() {\n    if (this.available === 0) return 0;\n    const sample = this.buffer[this.readPtr];\n    this.readPtr = (this.readPtr + 1) % this.capacity;\n    this.available--;\n    return sample;\n  }\n\n  /**\n   * Peek at samples without consuming them.\n   * @param {number} count\n   * @returns {Float32Array}\n   */\n  peek(count) {\n    const n = Math.min(count, this.available);\n    const result = new Float32Array(n);\n    let ptr = this.readPtr;\n    for (let i = 0; i < n; i++) {\n      result[i] = this.buffer[ptr];\n      ptr = (ptr + 1) % this.capacity;\n    }\n    return result;\n  }\n\n  /** Discard all data. */\n  clear() {\n    this.readPtr = 0;\n    this.writePtr = 0;\n    this.available = 0;\n  }\n}\n","/**\n * SVGMouthRenderer — Procedural SVG mouth animation driven by viseme shape parameters.\n *\n * Renders an animated mouth using SVG path elements, driven by the\n * {open, width, round} shape parameters from the FrequencyAnalyzer.\n *\n * No sprite sheet required — fully procedural.\n *\n * @module SVGMouthRenderer\n *\n * @example\n *   const mouth = new SVGMouthRenderer(svgContainer, {\n *     width: 120,\n *     height: 80,\n *     lipColor: '#d44',\n *     teethColor: '#fff',\n *   });\n *\n *   engine.on('viseme', (frame) => mouth.render(frame));\n */\n\nexport class SVGMouthRenderer {\n  /**\n   * @param {HTMLElement} container - DOM element to append the SVG into.\n   * @param {Object} [options]\n   * @param {number} [options.width=120]\n   * @param {number} [options.height=80]\n   * @param {string} [options.lipColor='#cc4444']\n   * @param {string} [options.innerColor='#3a1111']\n   * @param {string} [options.teethColor='#ffffff']\n   * @param {boolean} [options.showTeeth=true]\n   * @param {number} [options.lipThickness=3]\n   */\n  constructor(container, options = {}) {\n    this.container = container;\n    this.opts = {\n      width: 120,\n      height: 80,\n      lipColor: '#cc4444',\n      innerColor: '#3a1111',\n      teethColor: '#ffffff',\n      showTeeth: true,\n      lipThickness: 3,\n      ...options,\n    };\n\n    this._createSVG();\n    this._lastShape = { open: 0, width: 0.5, round: 0 };\n  }\n\n  /** @private Create the SVG structure. */\n  _createSVG() {\n    const ns = 'http://www.w3.org/2000/svg';\n    const { width, height } = this.opts;\n\n    this.svg = document.createElementNS(ns, 'svg');\n    this.svg.setAttribute('viewBox', `0 0 ${width} ${height}`);\n    this.svg.setAttribute('width', width);\n    this.svg.setAttribute('height', height);\n    this.svg.style.overflow = 'visible';\n\n    // Inner mouth (dark cavity)\n    this.innerPath = document.createElementNS(ns, 'path');\n    this.innerPath.setAttribute('fill', this.opts.innerColor);\n\n    // Teeth (upper row)\n    this.teethPath = document.createElementNS(ns, 'path');\n    this.teethPath.setAttribute('fill', this.opts.teethColor);\n    this.teethPath.setAttribute('opacity', '0.9');\n\n    // Lip outline\n    this.lipPath = document.createElementNS(ns, 'path');\n    this.lipPath.setAttribute('fill', 'none');\n    this.lipPath.setAttribute('stroke', this.opts.lipColor);\n    this.lipPath.setAttribute('stroke-width', this.opts.lipThickness);\n    this.lipPath.setAttribute('stroke-linecap', 'round');\n    this.lipPath.setAttribute('stroke-linejoin', 'round');\n\n    this.svg.appendChild(this.innerPath);\n    if (this.opts.showTeeth) {\n      this.svg.appendChild(this.teethPath);\n    }\n    this.svg.appendChild(this.lipPath);\n\n    this.container.appendChild(this.svg);\n\n    // Initial render (closed mouth)\n    this._renderShape({ open: 0, width: 0.5, round: 0 });\n  }\n\n  /**\n   * Render a viseme frame.\n   * @param {import('../analyzers/FrequencyAnalyzer.js').VisemeFrame} frame\n   */\n  render(frame) {\n    if (!frame.shape) return;\n    this._renderShape(frame.shape, frame.intensity);\n  }\n\n  /**\n   * Directly set mouth shape parameters.\n   * @param {{open: number, width: number, round: number}} shape\n   * @param {number} [intensity=0.5]\n   */\n  _renderShape(shape, intensity = 0.5) {\n    const { width: svgW, height: svgH } = this.opts;\n    const cx = svgW / 2;\n    const cy = svgH / 2;\n\n    // Map shape params to pixel dimensions\n    const mouthWidth = svgW * 0.3 + svgW * 0.5 * shape.width * (1 - shape.round * 0.4);\n    const mouthHeight = Math.max(1, svgH * 0.7 * shape.open);\n    const cornerRadius = shape.round * mouthWidth * 0.4;\n\n    const halfW = mouthWidth / 2;\n    const halfH = mouthHeight / 2;\n\n    // Control points for bezier curves\n    const cpx = halfW * (0.6 + shape.round * 0.3); // horizontal control\n    const cpy = halfH * (0.8 + shape.open * 0.2);  // vertical control\n\n    // Upper lip path\n    const upperLip = [\n      `M ${cx - halfW} ${cy}`,\n      `C ${cx - cpx} ${cy - cpy}, ${cx + cpx} ${cy - cpy}, ${cx + halfW} ${cy}`,\n    ].join(' ');\n\n    // Lower lip path\n    const lowerLip = [\n      `M ${cx - halfW} ${cy}`,\n      `C ${cx - cpx} ${cy + cpy}, ${cx + cpx} ${cy + cpy}, ${cx + halfW} ${cy}`,\n    ].join(' ');\n\n    // Combined lip outline\n    this.lipPath.setAttribute('d', `${upperLip} ${lowerLip}`);\n\n    // Inner mouth (filled cavity)\n    if (shape.open > 0.02) {\n      const innerScale = 0.85;\n      const iHalfW = halfW * innerScale;\n      const iHalfH = halfH * innerScale;\n      const icpx = cpx * innerScale;\n      const icpy = cpy * innerScale;\n\n      const innerD = [\n        `M ${cx - iHalfW} ${cy}`,\n        `C ${cx - icpx} ${cy - icpy}, ${cx + icpx} ${cy - icpy}, ${cx + iHalfW} ${cy}`,\n        `C ${cx + icpx} ${cy + icpy}, ${cx - icpx} ${cy + icpy}, ${cx - iHalfW} ${cy}`,\n        'Z',\n      ].join(' ');\n      this.innerPath.setAttribute('d', innerD);\n      this.innerPath.setAttribute('opacity', Math.min(1, shape.open * 2));\n    } else {\n      this.innerPath.setAttribute('d', '');\n      this.innerPath.setAttribute('opacity', '0');\n    }\n\n    // Teeth\n    if (this.opts.showTeeth && shape.open > 0.1) {\n      const teethW = halfW * 0.7;\n      const teethH = Math.min(halfH * 0.3, 8);\n      const teethY = cy - halfH * 0.3;\n      const teethD = [\n        `M ${cx - teethW} ${teethY}`,\n        `Q ${cx} ${teethY + teethH}, ${cx + teethW} ${teethY}`,\n        `L ${cx + teethW} ${teethY + teethH * 0.5}`,\n        `Q ${cx} ${teethY + teethH * 1.3}, ${cx - teethW} ${teethY + teethH * 0.5}`,\n        'Z',\n      ].join(' ');\n      this.teethPath.setAttribute('d', teethD);\n      this.teethPath.setAttribute('opacity', Math.min(0.9, shape.open * 1.5));\n    } else {\n      this.teethPath.setAttribute('d', '');\n      this.teethPath.setAttribute('opacity', '0');\n    }\n\n    this._lastShape = { ...shape };\n  }\n\n  /**\n   * Update renderer options dynamically.\n   * @param {Object} opts\n   */\n  updateOptions(opts) {\n    Object.assign(this.opts, opts);\n    if (opts.lipColor) this.lipPath.setAttribute('stroke', opts.lipColor);\n    if (opts.innerColor) this.innerPath.setAttribute('fill', opts.innerColor);\n    if (opts.teethColor) this.teethPath.setAttribute('fill', opts.teethColor);\n    if (opts.lipThickness) this.lipPath.setAttribute('stroke-width', opts.lipThickness);\n  }\n\n  /** Remove SVG from DOM and clean up. */\n  destroy() {\n    this.svg?.remove();\n    this.svg = null;\n  }\n}\n","/**\n * @beer-digital/lipsync-engine\n *\n * Production-grade, renderer-agnostic streaming lip-sync engine for\n * browser-based 2D animation. Real-time viseme detection from streaming\n * audio via AudioWorklet + Web Audio API.\n *\n * @example\n *   import {\n *     LipSyncEngine,\n *     SVGMouthRenderer,\n *     base64ToInt16,\n *   } from '@beer-digital/lipsync-engine';\n *\n *   const engine = new LipSyncEngine({ sampleRate: 24000 });\n *   const mouth = new SVGMouthRenderer(document.getElementById('mouth'));\n *\n *   await engine.init();\n *   engine.on('viseme', (frame) => mouth.render(frame));\n *   engine.startAnalysis();\n *\n *   // Feed audio from TTS API\n *   engine.feedAudio(base64ToInt16(audioChunk));\n *\n * @module @beer-digital/lipsync-engine\n */\n\n// ── Core ─────────────────────────────────────────────────────────\nexport { LipSyncEngine } from './core/LipSyncEngine.js';\n\n// ── Analyzers ────────────────────────────────────────────────────\nexport { FrequencyAnalyzer } from './analyzers/FrequencyAnalyzer.js';\n\n// ── Renderers ────────────────────────────────────────────────────\nexport { SVGMouthRenderer } from './renderers/SVGMouthRenderer.js';\nexport { CanvasRenderer } from './renderers/CanvasRenderer.js';\nexport { CSSClassRenderer } from './renderers/CSSClassRenderer.js';\n\n// ── Viseme data ──────────────────────────────────────────────────\nexport {\n  EXTENDED_VISEMES,\n  EXTENDED_VISEME_KEYS,\n  SIMPLE_VISEMES,\n  SIMPLE_VISEME_KEYS,\n  EXTENDED_TO_SIMPLE,\n  PHONEME_TO_VISEME,\n  ARPABET_PHONEMES,\n  VISEME_SHAPES,\n  TRANSITION_WEIGHTS,\n  getTransitionWeight,\n  interpolateShapes,\n} from './core/visemes.js';\n\n// ── Utilities ────────────────────────────────────────────────────\nexport {\n  int16ToFloat32,\n  float32ToInt16,\n  base64ToInt16,\n  int16ToBase64,\n  calculateRMS,\n  zeroCrossingRate,\n  extractBandEnergies,\n  smoothValue,\n  lerp,\n  clamp,\n  resample,\n} from './utils/audio-utils.js';\n\nexport { EventEmitter } from './utils/EventEmitter.js';\nexport { RingBuffer } from './utils/RingBuffer.js';\n\n// ── Version ──────────────────────────────────────────────────────\nexport const VERSION = '1.0.0';\n"],"names":["EventEmitter","constructor","this","_listeners","Map","on","event","fn","__privateGet","has","set","Set","get","add","off","once","wrapper","args","_original","delete","listener","size","emit","wildcard","removeAllListeners","clear","listenerCount","_a","int16ToFloat32","int16","float32","Float32Array","length","i","calculateRMS","data","isByte","sumSquares","len","value","Math","sqrt","extractBandEnergies","frequencyData","sampleRate","bands","defaultBands","name","min","max","binCount","binWidth","result","band","startBin","floor","endBin","sum","count","smoothValue","current","target","factor","clamp","resample","input","fromRate","toRate","ratio","outputLength","round","output","srcIndex","low","high","frac","WeakMap","EXTENDED_VISEMES","sil","label","description","PP","FF","TH","DD","kk","CH","SS","nn","RR","aa","E","I","O","U","EXTENDED_VISEME_KEYS","Object","keys","SIMPLE_VISEMES","A","extendedMap","B","C","D","F","SIMPLE_VISEME_KEYS","EXTENDED_TO_SIMPLE","simpleKey","def","entries","ext","PHONEME_TO_VISEME","AA","AE","AH","AO","AW","AY","EH","ER","EY","IH","IY","OW","OY","UH","UW","DH","G","HH","JH","K","L","M","N","NG","P","R","S","SH","T","V","W","Y","Z","ZH","ARPABET_PHONEMES","TRANSITION_WEIGHTS","getTransitionWeight","from","to","VISEME_SHAPES","open","width","DEFAULTS","fftSize","silenceThreshold","smoothingFactor","holdFrames","intensitySmoothing","energySmoothing","FrequencyAnalyzer","analyserNode","options","analyser","opts","smoothingTimeConstant","timeDomainData","Uint8Array","frequencyBinCount","_currentViseme","_currentIntensity","_holdCounter","_smoothedAmplitude","_smoothedBands","sub","mid","veryHigh","_previousViseme","_transitionProgress","_frameCount","analyze","getByteTimeDomainData","getByteFrequencyData","rawAmplitude","rawBands","key","_emitViseme","intensity","viseme","confidence","_classifyViseme","totalEnergy","sibilantScore","fricativeScore","flatness","abs","weight","prevShape","currShape","t","simpleViseme","amplitude","shape","transition","progress","frame","reset","analyserSmoothing","volume","startThresholdMs","bufferSeconds","analysisMode","analysisIntervalMs","workletUrl","disablePlayback","element","attribute","classPrefix","useSimpleVisemes","intensityAttribute","setIntensity","visemeClassMap","_currentClass","render","setAttribute","classList","remove","mapped","level","style","setProperty","_b","_c","_d","destroy","removeAttribute","canvas","ctx","getContext","offsetX","offsetY","scale","clearBeforeRender","spriteSheet","_ready","_currentFrame","_targetFrame","_blendProgress","_loadSpriteSheet","source","HTMLImageElement","complete","Promise","resolve","onload","Image","src","reject","onerror","columns","naturalWidth","frameWidth","frameIndex","visemeMap","cols","row","sx","sy","frameHeight","clearRect","height","dw","dh","drawImage","super","audioContext","workletNode","gainNode","analyzer","_mediaSource","_elementSource","_initialized","_analyzing","_animFrameId","_intervalId","_inputMode","_playbackTimeMs","_bufferLevel","_destroyed","init","existingContext","Error","AudioContext","state","resume","_resolveWorkletUrl","audioWorklet","addModule","AudioWorkletNode","processorOptions","createAnalyser","createGain","gain","connect","destination","port","onmessage","e","_onWorkletMessage","feedAudio","samples","inputSampleRate","_ensureInitialized","Int16Array","ArrayBuffer","isView","TypeError","buffer","srcRate","postMessage","type","attachStream","stream","_disconnectSources","createMediaStreamSource","attachElement","createMediaElementSource","disconnect","startAnalysis","_startRAFLoop","_startIntervalLoop","stopAnalysis","cancelAnimationFrame","clearInterval","tick","_analyzeFrame","requestAnimationFrame","setInterval","timeMs","bufferLevel","bufferMs","isPlaying","dropped","setVolume","v","setTargetAtTime","currentTime","clearBuffer","play","pause","initialized","analyzing","playbackTimeMs","inputMode","getState","_e","close","catch","capacity","readPtr","writePtr","available","free","empty","full","write","toWrite","writeOverflow","overwritten","read","offset","toRead","readOne","sample","peek","n","ptr","container","lipColor","innerColor","teethColor","showTeeth","lipThickness","_createSVG","_lastShape","ns","svg","document","createElementNS","overflow","innerPath","teethPath","lipPath","appendChild","_renderShape","svgW","svgH","cx","cy","mouthWidth","mouthHeight","halfW","halfH","cpx","cpy","upperLip","join","lowerLip","innerScale","iHalfW","icpx","icpy","innerD","teethW","teethH","teethY","teethD","updateOptions","assign","base64","binary","atob","bytes","charCodeAt","s","String","fromCharCode","btoa","fromViseme","toViseme","a","b","clampT","crossings"],"mappings":"uNAIO,MAAMA,EAAN,WAAAC,eAELC,OAAAC,QAAiBC,4GAAG,CAQpB,EAAAC,CAAGC,EAAOC,GAKR,OAJKC,EAAAN,KAAKC,GAAWM,IAAIH,IACvBE,EAAAN,KAAKC,GAAWO,IAAIJ,EAAO,IAAIK,KAEjCH,EAAAN,KAAKC,GAAWS,IAAIN,GAAOO,IAAIN,GACxB,IAAML,KAAKY,IAAIR,EAAOC,EAC/B,CAQA,IAAAQ,CAAKT,EAAOC,GACV,MAAMS,EAAU,IAAIC,KAClBf,KAAKY,IAAIR,EAAOU,GAChBT,KAAMU,IAGR,OADAD,EAAQE,UAAYX,EACbL,KAAKG,GAAGC,EAAOU,EACxB,CAOA,GAAAF,CAAIR,EAAOC,GACT,MAAMG,EAAMF,EAAAN,KAAKC,GAAWS,IAAIN,GAChC,GAAKI,EAAL,CACAA,EAAIS,OAAOZ,GAEX,IAAA,MAAWa,KAAYV,EACjBU,EAASF,YAAcX,GACzBG,EAAIS,OAAOC,GAGE,IAAbV,EAAIW,MAAYb,EAAAN,KAAKC,GAAWgB,OAAOb,EARjC,CASZ,CAOA,IAAAgB,CAAKhB,KAAUW,GACb,MAAMP,EAAMF,EAAAN,KAAKC,GAAWS,IAAIN,GAChC,GAAII,EACF,IAAA,MAAWH,KAAMG,EAAKH,KAAMU,GAG9B,MAAMM,EAAWf,EAAAN,KAAKC,GAAWS,IAAI,KACrC,GAAIW,EACF,IAAA,MAAWhB,KAAMgB,EAAUhB,EAAGD,KAAUW,EAE5C,CAGA,kBAAAO,CAAmBlB,GACbA,EACFE,EAAAN,KAAKC,GAAWgB,OAAOb,GAEvBE,EAAAN,KAAKC,GAAWsB,OAEpB,CAGA,aAAAC,CAAcpB,SACZ,OAAO,OAAAqB,SAAKxB,GAAWS,IAAIN,aAAQe,OAAQ,CAC7C,EC1EK,SAASO,EAAeC,GAC7B,MAAMC,EAAU,IAAIC,aAAaF,EAAMG,QACvC,IAAA,IAASC,EAAI,EAAGA,EAAIJ,EAAMG,OAAQC,IAChCH,EAAQG,GAAKJ,EAAMI,GAAK,MAE1B,OAAOH,CACT,CAmDO,SAASI,EAAaC,EAAMC,GAAS,GAC1C,IAAIC,EAAa,EACjB,MAAMC,EAAMH,EAAKH,OACjB,GAAY,IAARM,EAAW,OAAO,EAEtB,IAAA,IAASL,EAAI,EAAGA,EAAIK,EAAKL,IAAK,CAC5B,MAAMM,EAAQH,GAAUD,EAAKF,GAAK,KAAO,IAAME,EAAKF,GACpDI,GAAcE,EAAQA,CACxB,CACA,OAAOC,KAAKC,KAAKJ,EAAaC,EAChC,CAyBO,SAASI,EAAoBC,EAAeC,EAAYC,GAC7D,MAAMC,EAAeD,GAAS,CAC5B,CAAEE,KAAM,MAAYC,IAAK,GAAMC,IAAK,KACpC,CAAEF,KAAM,MAAYC,IAAK,IAAMC,IAAK,KACpC,CAAEF,KAAM,MAAYC,IAAK,IAAMC,IAAK,MACpC,CAAEF,KAAM,OAAYC,IAAK,KAAMC,IAAK,MACpC,CAAEF,KAAM,WAAYC,IAAK,KAAMC,IAAK,OAGhCC,EAAWP,EAAcX,OAEzBmB,EADUP,EAAa,EACFM,EACrBE,EAAS,CAAA,EAEf,IAAA,MAAWC,KAAQP,EAAc,CAC/B,MAAMQ,EAAWd,KAAKS,IAAI,EAAGT,KAAKe,MAAMF,EAAKL,IAAMG,IAC7CK,EAAShB,KAAKQ,IAAIE,EAAW,EAAGV,KAAKe,MAAMF,EAAKJ,IAAME,IAE5D,GAAIG,GAAYE,EAAQ,CACtBJ,EAAOC,EAAKN,MAAQ,EACpB,QACF,CAEA,IAAIU,EAAM,EACNC,EAAQ,EACZ,IAAA,IAASzB,EAAIqB,EAAUrB,GAAKuB,EAAQvB,IAClCwB,GAAOd,EAAcV,GAAK,IAC1ByB,IAEFN,EAAOC,EAAKN,MAAQW,EAAQ,EAAID,EAAMC,EAAQ,CAChD,CAEA,OAAON,CACT,CASO,SAASO,EAAYC,EAASC,EAAQC,GAC3C,OAAOF,GAAWC,EAASD,IAAY,EAAIE,EAC7C,CAoBO,SAASC,EAAMxB,EAAOS,EAAKC,GAChC,OAAOT,KAAKS,IAAID,EAAKR,KAAKQ,IAAIC,EAAKV,GACrC,CASO,SAASyB,EAASC,EAAOC,EAAUC,GACxC,GAAID,IAAaC,EAAQ,OAAOF,EAChC,MAAMG,EAAQF,EAAWC,EACnBE,EAAe7B,KAAK8B,MAAML,EAAMjC,OAASoC,GACzCG,EAAS,IAAIxC,aAAasC,GAChC,IAAA,IAASpC,EAAI,EAAGA,EAAIoC,EAAcpC,IAAK,CACrC,MAAMuC,EAAWvC,EAAImC,EACfK,EAAMjC,KAAKe,MAAMiB,GACjBE,EAAOlC,KAAKQ,IAAIyB,EAAM,EAAGR,EAAMjC,OAAS,GACxC2C,EAAOH,EAAWC,EACxBF,EAAOtC,GAAKgC,EAAMQ,IAAQ,EAAIE,GAAQV,EAAMS,GAAQC,CACtD,CACA,OAAOJ,CACT,CDxLEpE,EAAA,IAAAyE,QEMU,MAACC,EAAA,CACXC,IAAK,CAAEC,MAAO,SAAcC,YAAa,yBACzCC,GAAK,CAAEF,MAAO,QAAcC,YAAa,yBACzCE,GAAK,CAAEH,MAAO,MAAcC,YAAa,4BACzCG,GAAK,CAAEJ,MAAO,KAAcC,YAAa,wBACzCI,GAAK,CAAEL,MAAO,UAAcC,YAAa,0BACzCK,GAAK,CAAEN,MAAO,MAAcC,YAAa,yBACzCM,GAAK,CAAEP,MAAO,UAAcC,YAAa,uBACzCO,GAAK,CAAER,MAAO,MAAcC,YAAa,6BACzCQ,GAAK,CAAET,MAAO,OAAcC,YAAa,8BACzCS,GAAK,CAAEV,MAAO,IAAcC,YAAa,yBACzCU,GAAK,CAAEX,MAAO,QAAcC,YAAa,mBACzCW,EAAK,CAAEZ,MAAO,QAAcC,YAAa,4BACzCY,EAAK,CAAEb,MAAO,QAAcC,YAAa,wBACzCa,EAAK,CAAEd,MAAO,QAAcC,YAAa,wBACzCc,EAAK,CAAEf,MAAO,QAAcC,YAAa,0BAI9Be,EAAuBC,OAAOC,KAAKpB,GAInCqB,EAAA,CACXC,EAAG,CAAEpB,MAAO,sBAAwBqB,YAAa,CAAC,QAClDC,EAAG,CAAEtB,MAAO,YAAwBqB,YAAa,CAAC,KAAM,OACxDE,EAAG,CAAEvB,MAAO,uBAAyBqB,YAAa,CAAC,IAAK,IAAK,OAC7DG,EAAG,CAAExB,MAAO,iBAAwBqB,YAAa,CAAC,KAAM,KAAM,OAC9DT,EAAG,CAAEZ,MAAO,aAAwBqB,YAAa,CAAC,IAAK,KAAM,OAC7DI,EAAG,CAAEzB,MAAO,qBAAwBqB,YAAa,CAAC,KAAM,KAAM,OAInDK,EAAqBT,OAAOC,KAAKC,GAKjCQ,EAAqB,CAAA,EAClC,IAAA,MAAYC,EAAWC,KAAQZ,OAAOa,QAAQX,GAC5C,IAAA,MAAWY,KAAOF,EAAIR,YACpBM,EAAmBI,GAAOH,EAMlB,MAACI,EAAA,CAEXC,GAAI,KAAMC,GAAI,IAAMC,GAAI,KAAMC,GAAI,IAAMC,GAAI,KAC5CC,GAAI,KAAMC,GAAI,IAAMC,GAAI,KAAMC,GAAI,IAAMC,GAAI,IAC5CC,GAAI,IAAMC,GAAI,IAAMC,GAAI,IAAMC,GAAI,IAAMC,GAAI,IAE5CzB,EAAI,KAAMf,GAAI,KAAMiB,EAAI,KAAMwB,GAAI,KAAMvB,EAAI,KAC5CwB,EAAI,KAAMC,GAAI,KAAMC,GAAI,KAAMC,EAAI,KAAMC,EAAI,KAC5CC,EAAI,KAAMC,EAAI,KAAMC,GAAI,KAAMC,EAAI,KAAMC,EAAI,KAC5CC,EAAI,KAAMC,GAAI,KAAMC,EAAI,KAAMzD,GAAI,KAAM0D,EAAI,KAC5CC,EAAI,IAAMC,EAAI,IAAMC,EAAI,KAAMC,GAAI,MAIvBC,EAAmBlD,OAAOC,KAAKc,GAM/BoC,EAAqB,CAChCrE,IAAK,CAAEY,GAAI,GAAKC,EAAG,GAAKC,EAAG,GAAKC,EAAG,GAAKC,EAAG,GAAKb,GAAI,GAAKC,GAAI,IAC7DQ,GAAK,CAAEZ,IAAK,GAAKa,EAAG,GAAKE,EAAG,GAAKD,EAAG,GAAKX,GAAI,GAAKM,GAAI,IACtDN,GAAK,CAAES,GAAI,GAAKZ,IAAK,GAAKa,EAAG,GAAKT,GAAI,IACtCA,GAAK,CAAEQ,GAAI,GAAKT,GAAI,GAAKH,IAAK,IAC9BS,GAAK,CAAET,IAAK,GAAKY,GAAI,GAAKJ,GAAI,KASzB,SAAS8D,EAAoBC,EAAMC,SACxC,OAAO,OAAA3H,EAAAwH,EAAmBE,SAAnB,EAAA1H,EAA2B2H,KAAO,GAC3C,CAMY,MAACC,EAAgB,CAC3BzE,IAAK,CAAE0E,KAAM,EAAMC,MAAO,GAAMnF,MAAO,GACvCW,GAAK,CAAEuE,KAAM,EAAMC,MAAO,GAAMnF,MAAO,GACvCY,GAAK,CAAEsE,KAAM,IAAMC,MAAO,IAAMnF,MAAO,GACvCa,GAAK,CAAEqE,KAAM,GAAMC,MAAO,GAAMnF,MAAO,GACvCc,GAAK,CAAEoE,KAAM,GAAMC,MAAO,GAAMnF,MAAO,GACvCe,GAAK,CAAEmE,KAAM,IAAMC,MAAO,IAAMnF,MAAO,GACvCgB,GAAK,CAAEkE,KAAM,IAAMC,MAAO,IAAMnF,MAAO,IACvCiB,GAAK,CAAEiE,KAAM,IAAMC,MAAO,GAAMnF,MAAO,GACvCkB,GAAK,CAAEgE,KAAM,IAAMC,MAAO,GAAMnF,MAAO,GACvCmB,GAAK,CAAE+D,KAAM,GAAMC,MAAO,GAAMnF,MAAO,IACvCoB,GAAK,CAAE8D,KAAM,GAAMC,MAAO,GAAMnF,MAAO,GACvCqB,EAAK,CAAE6D,KAAM,GAAMC,MAAO,IAAMnF,MAAO,GACvCsB,EAAK,CAAE4D,KAAM,IAAMC,MAAO,GAAMnF,MAAO,GACvCuB,EAAK,CAAE2D,KAAM,GAAMC,MAAO,GAAMnF,MAAO,IACvCwB,EAAK,CAAE0D,KAAM,GAAMC,MAAO,GAAMnF,MAAO,KCvFzC,MAAMoF,EAAW,CACfC,QAAS,IACTC,iBAAkB,KAClBC,gBAAiB,IACjBC,WAAY,EACZC,mBAAoB,GACpBC,gBAAiB,IAGZ,MAAMC,EAMX,WAAAhK,CAAYiK,EAActH,EAAYuH,EAAU,CAAA,GAC9CjK,KAAKkK,SAAWF,EAChBhK,KAAK0C,WAAaA,EAClB1C,KAAKmK,KAAO,IAAKX,KAAaS,GAG9BjK,KAAKkK,SAAST,QAAUzJ,KAAKmK,KAAKV,QAClCzJ,KAAKkK,SAASE,sBAAwBpK,KAAKmK,KAAKL,gBAGhD9J,KAAKqK,eAAiB,IAAIC,WAAWtK,KAAKkK,SAAST,SACnDzJ,KAAKyC,cAAgB,IAAI6H,WAAWtK,KAAKkK,SAASK,mBAGlDvK,KAAKwK,eAAiB,MACtBxK,KAAKyK,kBAAoB,EACzBzK,KAAK0K,aAAe,EACpB1K,KAAK2K,mBAAqB,EAC1B3K,KAAK4K,eAAiB,CAAEC,IAAK,EAAGtG,IAAK,EAAGuG,IAAK,EAAGtG,KAAM,EAAGuG,SAAU,GACnE/K,KAAKgL,gBAAkB,MACvBhL,KAAKiL,oBAAsB,EAC3BjL,KAAKkL,YAAc,CACrB,CAQA,OAAAC,GACEnL,KAAKkL,cAGLlL,KAAKkK,SAASkB,sBAAsBpL,KAAKqK,gBACzCrK,KAAKkK,SAASmB,qBAAqBrL,KAAKyC,eAExC,MAAM6I,EAAetJ,EAAahC,KAAKqK,gBAAgB,GACvDrK,KAAK2K,mBAAqBlH,EACxBzD,KAAK2K,mBACLW,EACAtL,KAAKmK,KAAKR,iBAIZ,MAAM4B,EAAW/I,EAAoBxC,KAAKyC,cAAezC,KAAK0C,YAC9D,IAAA,MAAW8I,KAAO1F,OAAOC,KAAKwF,GAC5BvL,KAAK4K,eAAeY,GAAO/H,EACzBzD,KAAK4K,eAAeY,IAAQ,EAC5BD,EAASC,GACTxL,KAAKmK,KAAKR,iBAGd,MAAMhH,EAAQ3C,KAAK4K,eAGnB,GAAI5K,KAAK2K,mBAAqB3K,KAAKmK,KAAKT,iBACtC,OAAO1J,KAAKyL,YAAY,MAAO,EAAG9I,GAIpC,MAAM+I,EAAY7H,EAAgC,EAA1B7D,KAAK2K,mBAAwB,EAAG,IAClDgB,OAAEA,EAAAC,WAAQA,GAAe5L,KAAK6L,gBAAgBlJ,EAAO+I,GAG3D,GAAIC,IAAW3L,KAAKwK,eAAgB,CAElC,GADAxK,KAAK0K,eACD1K,KAAK0K,aAAe1K,KAAKmK,KAAKP,WAEhC,OAAO5J,KAAKyL,YAAYzL,KAAKwK,eAAgBkB,EAAW/I,GAE1D3C,KAAK0K,aAAe,CACtB,MACE1K,KAAK0K,aAAe,EAGtB,OAAO1K,KAAKyL,YAAYE,EAAQD,EAAW/I,EAAOiJ,EACpD,CAMA,eAAAC,CAAgBlJ,EAAO+I,GACrB,MAAMb,IAAEA,EAAAtG,IAAKA,EAAAuG,IAAKA,EAAAtG,KAAKA,EAAAuG,SAAMA,GAAapI,EACpCmJ,EAAcjB,EAAMtG,EAAMuG,EAAMtG,EAAOuG,EAE7C,GAAIe,EAAc,IAChB,MAAO,CAAEH,OAAQ,MAAOC,WAAY,IAItC,MAAMG,GAAiBvH,EAAOuG,IAAae,EAAc,MACzD,GAAIC,EAAgB,KAAQvH,EAAO,IACjC,OAAIuG,EAAkB,GAAPvG,EACN,CAAEmH,OAAQ,KAAMC,WAAYG,GAE9B,CAAEJ,OAAQ,KAAMC,WAA4B,IAAhBG,GAIrC,MAAMC,GAAkBlB,EAAMtG,IAASsH,EAAc,MACrD,GAAIE,EAAiB,IAAOxH,EAAO,IAAOD,EAAM,IAC9C,MAAO,CAAEoH,OAAQ,KAAMC,WAA6B,GAAjBI,GAKrC,MAAMC,EAAW,EAAI3J,KAAK4J,IAAI1H,EAAOD,IAAQuH,EAAc,MAC3D,OAAIJ,EAAY,IAAOO,EAAW,IAAOjM,KAAK2K,mBAAqB,IAC7DpG,EAAMuG,EACD,CAAEa,OAAQ,KAAMC,WAAY,IAE9B,CAAED,OAAQ,KAAMC,WAAY,IAIjCf,EAAM,IAAOtG,EAAM,KAAQC,EAAO,KAAQsG,EAAY,GAANvG,EAC3C,CAAEoH,OAAQ,KAAMC,WAAY,KAOjCrH,EAAM,IAAOuG,EAAM,KAAQY,EAAY,GAClC,CAAEC,OAAQ,KAAMC,WAAY,IAIjCd,EAAMvG,GAAOuG,EAAM,KAAQY,EAAY,GAClC,CAAEC,OAAQ,IAAKC,WAAY,KAIhCf,EAAMC,GAAOvG,EAAMuG,GAAOY,EAAY,GACjC,CAAEC,OAAQ,IAAKC,WAAY,IAIhCd,EAAM,IAAOtG,EAAa,GAAND,GAAamH,EAAY,GACxC,CAAEC,OAAQ,IAAKC,WAAY,KAIhCf,EAAM,KAAQrG,EAAO,IAChB,CAAEmH,OAAQ,IAAKC,WAAY,IAIhCF,EAAY,GAAY,CAAEC,OAAQ,KAAMC,WAAY,IACpDF,EAAY,GAAY,CAAEC,OAAQ,IAAKC,WAAY,KACnDF,EAAY,IAAa,CAAEC,OAAQ,IAAKC,WAAY,IACjD,CAAED,OAAQ,MAAOC,WAAY,GACtC,CAMA,WAAAH,CAAYE,EAAQD,EAAW/I,EAAOiJ,EAAa,IAEjD,GAAID,IAAW3L,KAAKwK,eAClBxK,KAAKgL,gBAAkBhL,KAAKwK,eAC5BxK,KAAKwK,eAAiBmB,EACtB3L,KAAKiL,oBAAsB,MACtB,CAEL,MAAMkB,EAASjD,EAAoBlJ,KAAKgL,gBAAiBhL,KAAKwK,gBAC9DxK,KAAKiL,oBAAsB3I,KAAKQ,IAAI,EAAG9C,KAAKiL,oBAAqC,IAAd,EAAIkB,GACzE,CAGAnM,KAAKyK,kBAAoBhH,EACvBzD,KAAKyK,kBACLiB,EACA1L,KAAKmK,KAAKN,oBAIZ,MAAMuC,EAAY/C,EAAcrJ,KAAKgL,kBAAoB3B,EAAczE,IACjEyH,EAAYhD,EAAcrJ,KAAKwK,iBAAmBnB,EAAczE,IAChE0H,EAAItM,KAAKiL,oBAEf,MAAO,CACLU,OAAQ3L,KAAKwK,eACb+B,aAAc/F,EAAmBxG,KAAKwK,iBAAmB,IACzDkB,UAAW1L,KAAKyK,kBAChBmB,aACAY,UAAWxM,KAAK2K,mBAChBhI,MAAO,IAAK3C,KAAK4K,gBACjB6B,MAAO,CACLnD,KAAO8C,EAAU9C,MAAS+C,EAAU/C,KAAQ8C,EAAU9C,MAASgD,EAC/D/C,MAAO6C,EAAU7C,OAAS8C,EAAU9C,MAAQ6C,EAAU7C,OAAS+C,EAC/DlI,MAAOgI,EAAUhI,OAASiI,EAAUjI,MAAQgI,EAAUhI,OAASkI,GAEjEI,WAAY,CACVvD,KAAMnJ,KAAKgL,gBACX5B,GAAIpJ,KAAKwK,eACTmC,SAAU3M,KAAKiL,qBAEjB2B,MAAO5M,KAAKkL,YAEhB,CAGA,KAAA2B,GACE7M,KAAKwK,eAAiB,MACtBxK,KAAKyK,kBAAoB,EACzBzK,KAAK0K,aAAe,EACpB1K,KAAK2K,mBAAqB,EAC1B3K,KAAK4K,eAAiB,CAAEC,IAAK,EAAGtG,IAAK,EAAGuG,IAAK,EAAGtG,KAAM,EAAGuG,SAAU,GACnE/K,KAAKgL,gBAAkB,MACvBhL,KAAKiL,oBAAsB,EAC3BjL,KAAKkL,YAAc,CACrB,EC9NF,MAAM1B,EAAW,CAEf9G,WAAY,KACZ+G,QAAS,IACTqD,kBAAmB,GAGnBpD,iBAAkB,KAClBC,gBAAiB,IACjBC,WAAY,EACZC,mBAAoB,GAGpBkD,OAAQ,EACRC,iBAAkB,GAClBC,cAAe,EAGfC,aAAc,MACdC,mBAAoB,GAGpBC,WAAY,KACZC,iBAAiB,uDCtCZ,MAWL,WAAAtN,CAAYuN,EAASrD,EAAU,IAC7BjK,KAAKsN,QAAUA,EACftN,KAAKmK,KAAO,CACVoD,UAAW,cACXC,YAAa,GACbC,kBAAkB,EAClBC,mBAAoB,iBACpBC,cAAc,EACdC,eAAgB,QACb3D,GAGLjK,KAAK6N,cAAgB,KACrB7N,KAAKwK,eAAiB,IACxB,CAMA,MAAAsD,CAAOlB,eACL,MAAMjB,EAAS3L,KAAKmK,KAAKsD,iBAAmBb,EAAML,aAAeK,EAAMjB,OAEvE,GAAIA,IAAW3L,KAAKwK,eAAgB,CAKlC,GAHAxK,KAAKsN,QAAQS,aAAa/N,KAAKmK,KAAKoD,UAAW5B,GAG3C3L,KAAKmK,KAAKqD,YAAa,CACrBxN,KAAK6N,eACP7N,KAAKsN,QAAQU,UAAUC,OAAOjO,KAAK6N,eAErC,MAAMK,EAAS,OAAAzM,EAAAzB,KAAKmK,KAAKyD,qBAAV,EAAAnM,EAA2BkK,GAC1C3L,KAAK6N,cAAgBK,GAAU,GAAGlO,KAAKmK,KAAKqD,cAAc7B,IAC1D3L,KAAKsN,QAAQU,UAAUrN,IAAIX,KAAK6N,cAClC,CAEA7N,KAAKwK,eAAiBmB,CACxB,CAGA,GAAI3L,KAAKmK,KAAKwD,aAAc,CAC1B,MAAMQ,EAAQ7L,KAAK8B,MAAwB,IAAlBwI,EAAMlB,WAC/B1L,KAAKsN,QAAQS,aAAa/N,KAAKmK,KAAKuD,mBAAoBS,GACxDnO,KAAKsN,QAAQc,MAAMC,YAAY,kBAAmBzB,EAAMlB,WACxD1L,KAAKsN,QAAQc,MAAMC,YAAY,cAAc,OAAAC,IAAM7B,YAAN,EAAA6B,EAAahF,OAAQ,GAClEtJ,KAAKsN,QAAQc,MAAMC,YAAY,eAAe,OAAAE,IAAM9B,YAAN,EAAA8B,EAAahF,QAAS,IACpEvJ,KAAKsN,QAAQc,MAAMC,YAAY,eAAe,OAAAG,IAAM/B,YAAN,EAAA+B,EAAapK,QAAS,EACtE,CACF,CAGA,OAAAqK,GACMzO,KAAK6N,eACP7N,KAAKsN,QAAQU,UAAUC,OAAOjO,KAAK6N,eAErC7N,KAAKsN,QAAQoB,gBAAgB1O,KAAKmK,KAAKoD,WACvCvN,KAAKsN,QAAQoB,gBAAgB1O,KAAKmK,KAAKuD,oBACvC1N,KAAKwK,eAAiB,IACxB,0BCzEK,MAcL,WAAAzK,CAAY4O,EAAQ1E,GAClBjK,KAAK2O,OAASA,EACd3O,KAAK4O,IAAMD,EAAOE,WAAW,MAC7B7O,KAAKmK,KAAO,CACV2E,QAAS,EACTC,QAAS,EACTC,MAAO,EACPC,mBAAmB,KAChBhF,GAILjK,KAAKkP,YAAc,KACnBlP,KAAKmP,QAAS,EACdnP,KAAKoP,cAAgB,EACrBpP,KAAKqP,aAAe,EACpBrP,KAAKsP,eAAiB,EAEtBtP,KAAKuP,iBAAiBtF,EAAQiF,YAChC,CAGA,sBAAMK,CAAiBC,GACjBA,aAAkBC,kBACpBzP,KAAKkP,YAAcM,EACfA,EAAOE,gBAGH,IAAIC,QAASC,IACjBJ,EAAOK,OAASD,IAHlB5P,KAAKmP,QAAS,GAOW,iBAAXK,IAChBxP,KAAKkP,YAAc,IAAIY,MACvB9P,KAAKkP,YAAYa,IAAMP,QACjB,IAAIG,QAAQ,CAACC,EAASI,KAC1BhQ,KAAKkP,YAAYW,OAASD,EAC1B5P,KAAKkP,YAAYe,QAAUD,IAE7BhQ,KAAKmP,QAAS,IAIXnP,KAAKmK,KAAK+F,SAAWlQ,KAAKkP,cAC7BlP,KAAKmK,KAAK+F,QAAU5N,KAAKe,MACvBrD,KAAKkP,YAAYiB,aAAenQ,KAAKmK,KAAKiG,YAGhD,CAMA,MAAAtC,CAAOlB,GACL,IAAK5M,KAAKmP,SAAWnP,KAAKkP,YAAa,OAEvC,MAAMmB,EAAarQ,KAAKmK,KAAKmG,UAAU1D,EAAMjB,SAAW3L,KAAKmK,KAAKmG,UAAU1L,KAAO,EAC7E2L,EAAOvQ,KAAKmK,KAAK+F,SAAW,EAC5BM,EAAMlO,KAAKe,MAAMgN,EAAaE,GAG9BE,EAFMJ,EAAaE,EAERvQ,KAAKmK,KAAKiG,WACrBM,EAAKF,EAAMxQ,KAAKmK,KAAKwG,YAEvB3Q,KAAKmK,KAAK8E,mBACZjP,KAAK4O,IAAIgC,UAAU,EAAG,EAAG5Q,KAAK2O,OAAOpF,MAAOvJ,KAAK2O,OAAOkC,QAG1D,MAAMC,EAAK9Q,KAAKmK,KAAKiG,WAAapQ,KAAKmK,KAAK6E,MACtC+B,EAAK/Q,KAAKmK,KAAKwG,YAAc3Q,KAAKmK,KAAK6E,MAE7ChP,KAAK4O,IAAIoC,UACPhR,KAAKkP,YACLuB,EAAIC,EAAI1Q,KAAKmK,KAAKiG,WAAYpQ,KAAKmK,KAAKwG,YACxC3Q,KAAKmK,KAAK2E,QAAS9O,KAAKmK,KAAK4E,QAAS+B,EAAIC,EAE9C,CAGA,OAAAtC,GACEzO,KAAKkP,YAAc,KACnBlP,KAAKmP,QAAS,CAChB,mKFtDK,cAA4BrP,EAIjC,WAAAC,CAAYkK,EAAU,IACpBgH,QACAjR,KAAKmK,KAAO,IAAKX,KAAaS,GAG9BjK,KAAKkR,aAAe,KAGpBlR,KAAKmR,YAAc,KAGnBnR,KAAKgK,aAAe,KAGpBhK,KAAKoR,SAAW,KAGhBpR,KAAKqR,SAAW,KAGhBrR,KAAKsR,aAAe,KAGpBtR,KAAKuR,eAAiB,KAGtBvR,KAAKwR,cAAe,EACpBxR,KAAKyR,YAAa,EAClBzR,KAAK0R,aAAe,KACpB1R,KAAK2R,YAAc,KACnB3R,KAAK4R,WAAa,KAClB5R,KAAK6R,gBAAkB,EACvB7R,KAAK8R,aAAe,EACpB9R,KAAK+R,YAAa,CACpB,CAWA,UAAMC,CAAKC,GACT,GAAIjS,KAAKwR,aAAc,OACvB,GAAIxR,KAAK+R,WAAY,MAAM,IAAIG,MAAM,6BAGrClS,KAAKkR,aAAee,GAAmB,IAAIE,aAAa,CACtDzP,WAAY1C,KAAKmK,KAAKzH,aAIQ,cAA5B1C,KAAKkR,aAAakB,aACdpS,KAAKkR,aAAamB,SAI1B,MAAMjF,EAAapN,KAAKmK,KAAKiD,YAAcpN,KAAKsS,2BAC1CtS,KAAKkR,aAAaqB,aAAaC,UAAUpF,GAG/CpN,KAAKmR,YAAc,IAAIsB,iBACrBzS,KAAKkR,aACL,sBACA,CACEwB,iBAAkB,CAChBhQ,WAAY1C,KAAKmK,KAAKzH,WACtBuK,cAAejN,KAAKmK,KAAK8C,cACzBD,iBAAkBhN,KAAKmK,KAAK6C,oBAMlChN,KAAKgK,aAAehK,KAAKkR,aAAayB,iBACtC3S,KAAKgK,aAAaP,QAAUzJ,KAAKmK,KAAKV,QACtCzJ,KAAKgK,aAAaI,sBAAwBpK,KAAKmK,KAAK2C,kBAGpD9M,KAAKoR,SAAWpR,KAAKkR,aAAa0B,aAClC5S,KAAKoR,SAASyB,KAAKxQ,MAAQrC,KAAKmK,KAAK4C,OAGrC/M,KAAKmR,YAAY2B,QAAQ9S,KAAKgK,cACzBhK,KAAKmK,KAAKkD,kBACbrN,KAAKgK,aAAa8I,QAAQ9S,KAAKoR,UAC/BpR,KAAKoR,SAAS0B,QAAQ9S,KAAKkR,aAAa6B,cAI1C/S,KAAKqR,SAAW,IAAItH,EAClB/J,KAAKgK,aACLhK,KAAKkR,aAAaxO,WAClB,CACE+G,QAASzJ,KAAKmK,KAAKV,QACnBC,iBAAkB1J,KAAKmK,KAAKT,iBAC5BC,gBAAiB3J,KAAKmK,KAAKR,gBAC3BC,WAAY5J,KAAKmK,KAAKP,WACtBC,mBAAoB7J,KAAKmK,KAAKN,qBAKlC7J,KAAKmR,YAAY6B,KAAKC,UAAaC,GAAMlT,KAAKmT,kBAAkBD,EAAEjR,MAElEjC,KAAKwR,cAAe,EACpBxR,KAAK4R,WAAa,SAClB5R,KAAKoB,KAAK,cACZ,CAMA,kBAAAkR,GAWE,MARE,0BASJ,CAaA,SAAAc,CAAUC,EAASC,GAGjB,IAAI1R,EAEJ,GAJA5B,KAAKuT,qBAIDF,aAAmBG,WACrB5R,EAAUF,EAAe2R,QAC3B,GAAWA,aAAmBxR,aAC5BD,EAAUyR,OACZ,GAAWA,aAAmBI,YAE5B7R,EAAUF,EAAe,IAAI8R,WAAWH,QAC1C,KAAWI,YAAYC,OAAOL,GAG5B,MAAM,IAAIM,UAAU,8DAFpB/R,EAAUF,EAAe,IAAI8R,WAAWH,EAAQO,QAGlD,CAGA,MAAMC,EAAUP,GAAmBtT,KAAKmK,KAAKzH,WACzCmR,IAAY7T,KAAKkR,aAAaxO,aAChCd,EAAUkC,EAASlC,EAASiS,EAAS7T,KAAKkR,aAAaxO,aAIzD1C,KAAKmR,YAAY6B,KAAKc,YACpB,CAAEC,KAAM,QAASV,QAASzR,GAC1B,CAACA,EAAQgS,QAEb,CAQA,YAAAI,CAAaC,GACXjU,KAAKuT,qBACLvT,KAAKkU,qBAELlU,KAAKsR,aAAetR,KAAKkR,aAAaiD,wBAAwBF,GAC9DjU,KAAKsR,aAAawB,QAAQ9S,KAAKgK,cAG/BhK,KAAK4R,WAAa,QAClB5R,KAAKoB,KAAK,iBAAkB,CAAE2S,KAAM,UACtC,CAOA,aAAAK,CAAc9G,GACZtN,KAAKuT,qBACLvT,KAAKkU,qBAELlU,KAAKuR,eAAiBvR,KAAKkR,aAAamD,yBAAyB/G,GACjEtN,KAAKuR,eAAeuB,QAAQ9S,KAAKgK,cACjChK,KAAKgK,aAAa8I,QAAQ9S,KAAKkR,aAAa6B,aAE5C/S,KAAK4R,WAAa,UAClB5R,KAAKoB,KAAK,iBAAkB,CAAE2S,KAAM,WACtC,CAMA,kBAAAG,GACE,GAAIlU,KAAKsR,aAAc,CACrB,IAAMtR,KAAKsR,aAAagD,YAAc,CAAA,MAAS,CAC/CtU,KAAKsR,aAAe,IACtB,CACA,GAAItR,KAAKuR,eAAgB,CACvB,IAAMvR,KAAKuR,eAAe+C,YAAc,CAAA,MAAS,CACjDtU,KAAKuR,eAAiB,IACxB,CACF,CAUA,aAAAgD,GACMvU,KAAKyR,aACTzR,KAAKuT,qBACLvT,KAAKyR,YAAa,EAEa,QAA3BzR,KAAKmK,KAAK+C,aACZlN,KAAKwU,gBAELxU,KAAKyU,qBAGPzU,KAAKoB,KAAK,mBACZ,CAGA,YAAAsT,GACE1U,KAAKyR,YAAa,EAEQ,OAAtBzR,KAAK0R,eACPiD,qBAAqB3U,KAAK0R,cAC1B1R,KAAK0R,aAAe,MAEG,OAArB1R,KAAK2R,cACPiD,cAAc5U,KAAK2R,aACnB3R,KAAK2R,YAAc,MAGrB3R,KAAKoB,KAAK,kBACZ,CAGA,aAAAoT,GACE,MAAMK,EAAO,KACN7U,KAAKyR,aACVzR,KAAK8U,gBACL9U,KAAK0R,aAAeqD,sBAAsBF,KAE5C7U,KAAK0R,aAAeqD,sBAAsBF,EAC5C,CAGA,kBAAAJ,GACEzU,KAAK2R,YAAcqD,YAAY,KACxBhV,KAAKyR,YACVzR,KAAK8U,iBACJ9U,KAAKmK,KAAKgD,mBACf,CAGA,aAAA2H,GACE,MAAMlI,EAAQ5M,KAAKqR,SAASlG,UAC5ByB,EAAMqI,OAASjV,KAAK6R,gBACpBjF,EAAMsI,YAAclV,KAAK8R,aACzB9R,KAAKoB,KAAK,SAAUwL,EACtB,CAOA,iBAAAuG,CAAkBlR,GAChB,OAAQA,EAAK8R,MACX,IAAK,WACH/T,KAAK6R,gBAAkB5P,EAAKgT,OAC5BjV,KAAK8R,aAAe7P,EAAKiT,YACzBlV,KAAKoB,KAAK,WAAY,CACpB6T,OAAQhT,EAAKgT,OACbC,YAAajT,EAAKiT,YAClBC,SAAUlT,EAAKkT,SACfC,UAAWnT,EAAKmT,YAElB,MAEF,IAAK,kBACHpV,KAAKoB,KAAK,mBACV,MAEF,IAAK,gBACHpB,KAAKoB,KAAK,iBACV,MAEF,IAAK,iBACHpB,KAAKoB,KAAK,iBAAkB,CAAE6T,OAAQhT,EAAKgT,SAC3C,MAEF,IAAK,iBACHjV,KAAKoB,KAAK,iBAAkB,CAAEiU,QAASpT,EAAKoT,UAC5C,MAEF,IAAK,QACHrV,KAAKoB,KAAK,gBAGhB,CAUA,SAAAkU,CAAUjT,SACR,MAAMkT,EAAIjT,KAAKS,IAAI,EAAGT,KAAKQ,IAAI,EAAGT,IAC9BrC,KAAKoR,UACPpR,KAAKoR,SAASyB,KAAK2C,gBAAgBD,EAAGvV,KAAKkR,aAAauE,YAAa,KAEvE,OAAAhU,EAAAzB,KAAKmR,gBAAa6B,KAAKc,YAAY,CAAEC,KAAM,YAAa1R,MAAOkT,GACjE,CAGA,WAAAG,SACE,OAAAjU,EAAAzB,KAAKmR,cAAL1P,EAAkBuR,KAAKc,YAAY,CAAEC,KAAM,SAC7C,CAGA,IAAA4B,SACE,OAAAlU,EAAAzB,KAAKmR,cAAL1P,EAAkBuR,KAAKc,YAAY,CAAEC,KAAM,SAC7C,CAGA,KAAA6B,SACE,OAAAnU,EAAAzB,KAAKmR,cAAL1P,EAAkBuR,KAAKc,YAAY,CAAEC,KAAM,QAC7C,CAGA,KAAAlH,WACE,OAAApL,EAAAzB,KAAKmR,cAAL1P,EAAkBuR,KAAKc,YAAY,CAAEC,KAAM,UAC3C,OAAAzF,EAAAtO,KAAKqR,WAAL/C,EAAezB,QACf7M,KAAK6R,gBAAkB,EACvB7R,KAAK8R,aAAe,EACpB9R,KAAKoB,KAAK,QACZ,CAOA,eAAIyU,GAAgB,OAAO7V,KAAKwR,YAAc,CAG9C,aAAIsE,GAAc,OAAO9V,KAAKyR,UAAY,CAG1C,kBAAIsE,GAAmB,OAAO/V,KAAK6R,eAAiB,CAGpD,eAAIqD,GAAgB,OAAOlV,KAAK8R,YAAc,CAG9C,aAAIkE,GAAc,OAAOhW,KAAK4R,UAAY,CAM1C,QAAAqE,WACE,MAAO,CACLJ,YAAa7V,KAAKwR,aAClBsE,UAAW9V,KAAKyR,WAChBuE,UAAWhW,KAAK4R,WAChBmE,eAAgB/V,KAAK6R,gBACrBqD,YAAalV,KAAK8R,aAClBpP,WAAY,OAAAjB,EAAAzB,KAAKkR,mBAAL,EAAAzP,EAAmBiB,WAC/BqK,OAAQ,OAAAuB,EAAAtO,KAAKoR,eAAL,EAAA9C,EAAeuE,KAAKxQ,MAEhC,CASA,OAAAoM,iBACE,IAAIzO,KAAK+R,WAAT,CACA/R,KAAK+R,YAAa,EAElB/R,KAAK0U,eACL1U,KAAKkU,qBAEL,IAAM,OAAAzS,EAAAzB,KAAKmR,cAAL1P,EAAkB6S,YAAc,CAAA,MAAS,CAC/C,IAAM,OAAAhG,EAAAtO,KAAKgK,eAALsE,EAAmBgG,YAAc,CAAA,MAAS,CAChD,IAAM,OAAA/F,EAAAvO,KAAKoR,WAAL7C,EAAe+F,YAAc,CAAA,MAAS,CAGX,YAA7B,OAAA9F,EAAAxO,KAAKkR,mBAAL,EAAA1C,EAAmB4D,SACrB,OAAA8D,EAAAlW,KAAKkR,eAALgF,EAAmBC,QAAQC,MAAM,SAGnCpW,KAAKmR,YAAc,KACnBnR,KAAKgK,aAAe,KACpBhK,KAAKoR,SAAW,KAChBpR,KAAKqR,SAAW,KAChBrR,KAAKkR,aAAe,KACpBlR,KAAKwR,cAAe,EAEpBxR,KAAKsB,qBACLtB,KAAKoB,KAAK,YAvBW,CAwBvB,CAGA,kBAAAmS,GACE,IAAKvT,KAAKwR,aACR,MAAM,IAAIU,MAAM,oDAEpB,kDGrfK,MAIL,WAAAnS,CAAYsW,GAEVrW,KAAK4T,OAAS,IAAI/R,aAAawU,GAE/BrW,KAAKqW,SAAWA,EAEhBrW,KAAKsW,QAAU,EAEftW,KAAKuW,SAAW,EAEhBvW,KAAKwW,UAAY,CACnB,CAGA,UAAI1U,GACF,OAAO9B,KAAKwW,SACd,CAGA,QAAIC,GACF,OAAOzW,KAAKqW,SAAWrW,KAAKwW,SAC9B,CAGA,SAAIE,GACF,OAA0B,IAAnB1W,KAAKwW,SACd,CAGA,QAAIG,GACF,OAAO3W,KAAKwW,YAAcxW,KAAKqW,QACjC,CAGA,SAAIlI,GACF,OAAOnO,KAAKwW,UAAYxW,KAAKqW,QAC/B,CAOA,KAAAO,CAAMvD,GACJ,MAAMwD,EAAUvU,KAAKQ,IAAIuQ,EAAQvR,OAAQ9B,KAAKyW,MAC9C,IAAA,IAAS1U,EAAI,EAAGA,EAAI8U,EAAS9U,IAC3B/B,KAAK4T,OAAO5T,KAAKuW,UAAYlD,EAAQtR,GACrC/B,KAAKuW,UAAYvW,KAAKuW,SAAW,GAAKvW,KAAKqW,SAG7C,OADArW,KAAKwW,WAAaK,EACXA,CACT,CAOA,aAAAC,CAAczD,GACZ,IAAI0D,EAAc,EAClB,IAAA,IAAShV,EAAI,EAAGA,EAAIsR,EAAQvR,OAAQC,IAC9B/B,KAAKwW,WAAaxW,KAAKqW,UAEzBrW,KAAKsW,SAAWtW,KAAKsW,QAAU,GAAKtW,KAAKqW,SACzCU,KAEA/W,KAAKwW,YAEPxW,KAAK4T,OAAO5T,KAAKuW,UAAYlD,EAAQtR,GACrC/B,KAAKuW,UAAYvW,KAAKuW,SAAW,GAAKvW,KAAKqW,SAE7C,OAAOU,CACT,CASA,IAAAC,CAAKrT,EAAQsT,EAAS,EAAGzT,GACvB,MAAM0T,EAAS5U,KAAKQ,IAAIU,GAAUG,EAAO7B,OAASmV,EAASjX,KAAKwW,WAChE,IAAA,IAASzU,EAAI,EAAGA,EAAImV,EAAQnV,IAC1B4B,EAAOsT,EAASlV,GAAK/B,KAAK4T,OAAO5T,KAAKsW,SACtCtW,KAAKsW,SAAWtW,KAAKsW,QAAU,GAAKtW,KAAKqW,SAG3C,OADArW,KAAKwW,WAAaU,EACXA,CACT,CAMA,OAAAC,GACE,GAAuB,IAAnBnX,KAAKwW,UAAiB,OAAO,EACjC,MAAMY,EAASpX,KAAK4T,OAAO5T,KAAKsW,SAGhC,OAFAtW,KAAKsW,SAAWtW,KAAKsW,QAAU,GAAKtW,KAAKqW,SACzCrW,KAAKwW,YACEY,CACT,CAOA,IAAAC,CAAK7T,GACH,MAAM8T,EAAIhV,KAAKQ,IAAIU,EAAOxD,KAAKwW,WACzBtT,EAAS,IAAIrB,aAAayV,GAChC,IAAIC,EAAMvX,KAAKsW,QACf,IAAA,IAASvU,EAAI,EAAGA,EAAIuV,EAAGvV,IACrBmB,EAAOnB,GAAK/B,KAAK4T,OAAO2D,GACxBA,GAAOA,EAAM,GAAKvX,KAAKqW,SAEzB,OAAOnT,CACT,CAGA,KAAA3B,GACEvB,KAAKsW,QAAU,EACftW,KAAKuW,SAAW,EAChBvW,KAAKwW,UAAY,CACnB,kFClHK,MAYL,WAAAzW,CAAYyX,EAAWvN,EAAU,IAC/BjK,KAAKwX,UAAYA,EACjBxX,KAAKmK,KAAO,CACVZ,MAAO,IACPsH,OAAQ,GACR4G,SAAU,UACVC,WAAY,UACZC,WAAY,UACZC,WAAW,EACXC,aAAc,KACX5N,GAGLjK,KAAK8X,aACL9X,KAAK+X,WAAa,CAAEzO,KAAM,EAAGC,MAAO,GAAKnF,MAAO,EAClD,CAGA,UAAA0T,GACE,MAAME,EAAK,8BACLzO,MAAEA,EAAAsH,OAAOA,GAAW7Q,KAAKmK,KAE/BnK,KAAKiY,IAAMC,SAASC,gBAAgBH,EAAI,OACxChY,KAAKiY,IAAIlK,aAAa,UAAW,OAAOxE,KAASsH,KACjD7Q,KAAKiY,IAAIlK,aAAa,QAASxE,GAC/BvJ,KAAKiY,IAAIlK,aAAa,SAAU8C,GAChC7Q,KAAKiY,IAAI7J,MAAMgK,SAAW,UAG1BpY,KAAKqY,UAAYH,SAASC,gBAAgBH,EAAI,QAC9ChY,KAAKqY,UAAUtK,aAAa,OAAQ/N,KAAKmK,KAAKuN,YAG9C1X,KAAKsY,UAAYJ,SAASC,gBAAgBH,EAAI,QAC9ChY,KAAKsY,UAAUvK,aAAa,OAAQ/N,KAAKmK,KAAKwN,YAC9C3X,KAAKsY,UAAUvK,aAAa,UAAW,OAGvC/N,KAAKuY,QAAUL,SAASC,gBAAgBH,EAAI,QAC5ChY,KAAKuY,QAAQxK,aAAa,OAAQ,QAClC/N,KAAKuY,QAAQxK,aAAa,SAAU/N,KAAKmK,KAAKsN,UAC9CzX,KAAKuY,QAAQxK,aAAa,eAAgB/N,KAAKmK,KAAK0N,cACpD7X,KAAKuY,QAAQxK,aAAa,iBAAkB,SAC5C/N,KAAKuY,QAAQxK,aAAa,kBAAmB,SAE7C/N,KAAKiY,IAAIO,YAAYxY,KAAKqY,WACtBrY,KAAKmK,KAAKyN,WACZ5X,KAAKiY,IAAIO,YAAYxY,KAAKsY,WAE5BtY,KAAKiY,IAAIO,YAAYxY,KAAKuY,SAE1BvY,KAAKwX,UAAUgB,YAAYxY,KAAKiY,KAGhCjY,KAAKyY,aAAa,CAAEnP,KAAM,EAAGC,MAAO,GAAKnF,MAAO,GAClD,CAMA,MAAA0J,CAAOlB,GACAA,EAAMH,OACXzM,KAAKyY,aAAa7L,EAAMH,MAAOG,EAAMlB,UACvC,CAOA,YAAA+M,CAAahM,EAAOf,EAAY,IAC9B,MAAQnC,MAAOmP,EAAM7H,OAAQ8H,GAAS3Y,KAAKmK,KACrCyO,EAAKF,EAAO,EACZG,EAAKF,EAAO,EAGZG,EAAoB,GAAPJ,EAAoB,GAAPA,EAAajM,EAAMlD,OAAS,EAAkB,GAAdkD,EAAMrI,OAChE2U,EAAczW,KAAKS,IAAI,EAAU,GAAP4V,EAAalM,EAAMnD,MAC9BmD,EAAMrI,MAE3B,MAAM4U,EAAQF,EAAa,EACrBG,EAAQF,EAAc,EAGtBG,EAAMF,GAAS,GAAoB,GAAdvM,EAAMrI,OAC3B+U,EAAMF,GAAS,GAAmB,GAAbxM,EAAMnD,MAG3B8P,EAAW,CACf,KAAKR,EAAKI,KAASH,IACnB,KAAKD,EAAKM,KAAOL,EAAKM,MAAQP,EAAKM,KAAOL,EAAKM,MAAQP,EAAKI,KAASH,KACrEQ,KAAK,KAGDC,EAAW,CACf,KAAKV,EAAKI,KAASH,IACnB,KAAKD,EAAKM,KAAOL,EAAKM,MAAQP,EAAKM,KAAOL,EAAKM,MAAQP,EAAKI,KAASH,KACrEQ,KAAK,KAMP,GAHArZ,KAAKuY,QAAQxK,aAAa,IAAK,GAAGqL,KAAYE,KAG1C7M,EAAMnD,KAAO,IAAM,CACrB,MAAMiQ,EAAa,IACbC,EAASR,EAAQO,EAEjBE,EAAOP,EAAMK,EACbG,EAAOP,EAAMI,EAEbI,EAAS,CACb,KAAKf,EAAKY,KAAUX,IACpB,KAAKD,EAAKa,KAAQZ,EAAKa,MAASd,EAAKa,KAAQZ,EAAKa,MAASd,EAAKY,KAAUX,IAC1E,KAAKD,EAAKa,KAAQZ,EAAKa,MAASd,EAAKa,KAAQZ,EAAKa,MAASd,EAAKY,KAAUX,IAC1E,KACAQ,KAAK,KACPrZ,KAAKqY,UAAUtK,aAAa,IAAK4L,GACjC3Z,KAAKqY,UAAUtK,aAAa,UAAWzL,KAAKQ,IAAI,EAAgB,EAAb2J,EAAMnD,MAC3D,MACEtJ,KAAKqY,UAAUtK,aAAa,IAAK,IACjC/N,KAAKqY,UAAUtK,aAAa,UAAW,KAIzC,GAAI/N,KAAKmK,KAAKyN,WAAanL,EAAMnD,KAAO,GAAK,CAC3C,MAAMsQ,EAAiB,GAARZ,EACTa,EAASvX,KAAKQ,IAAY,GAARmW,EAAa,GAC/Ba,EAASjB,EAAa,GAARI,EACdc,EAAS,CACb,KAAKnB,EAAKgB,KAAUE,IACpB,KAAKlB,KAAMkB,EAASD,MAAWjB,EAAKgB,KAAUE,IAC9C,KAAKlB,EAAKgB,KAAUE,EAAkB,GAATD,IAC7B,KAAKjB,KAAMkB,EAAkB,IAATD,MAAiBjB,EAAKgB,KAAUE,EAAkB,GAATD,IAC7D,KACAR,KAAK,KACPrZ,KAAKsY,UAAUvK,aAAa,IAAKgM,GACjC/Z,KAAKsY,UAAUvK,aAAa,UAAWzL,KAAKQ,IAAI,GAAkB,IAAb2J,EAAMnD,MAC7D,MACEtJ,KAAKsY,UAAUvK,aAAa,IAAK,IACjC/N,KAAKsY,UAAUvK,aAAa,UAAW,KAGzC/N,KAAK+X,WAAa,IAAKtL,EACzB,CAMA,aAAAuN,CAAc7P,GACZrE,OAAOmU,OAAOja,KAAKmK,KAAMA,GACrBA,EAAKsN,UAAUzX,KAAKuY,QAAQxK,aAAa,SAAU5D,EAAKsN,UACxDtN,EAAKuN,YAAY1X,KAAKqY,UAAUtK,aAAa,OAAQ5D,EAAKuN,YAC1DvN,EAAKwN,YAAY3X,KAAKsY,UAAUvK,aAAa,OAAQ5D,EAAKwN,YAC1DxN,EAAK0N,cAAc7X,KAAKuY,QAAQxK,aAAa,eAAgB5D,EAAK0N,aACxE,CAGA,OAAApJ,SACE,OAAAhN,EAAAzB,KAAKiY,MAALxW,EAAUwM,SACVjO,KAAKiY,IAAM,IACb,gDC3HqB,sDRlChB,SAAuBiC,GAC5B,MAAMC,EAASC,KAAKF,GACdG,EAAQ,IAAI/P,WAAW6P,EAAOrY,QACpC,IAAA,IAASC,EAAI,EAAGA,EAAIoY,EAAOrY,OAAQC,IACjCsY,EAAMtY,GAAKoY,EAAOG,WAAWvY,GAE/B,OAAO,IAAIyR,WAAW6G,EAAMzG,OAC9B,8FAtBO,SAAwBhS,GAC7B,MAAMD,EAAQ,IAAI6R,WAAW5R,EAAQE,QACrC,IAAA,IAASC,EAAI,EAAGA,EAAIH,EAAQE,OAAQC,IAAK,CACvC,MAAMwY,EAAIjY,KAAKS,KAAI,EAAIT,KAAKQ,IAAI,EAAGlB,EAAQG,KAC3CJ,EAAMI,GAAKwY,EAAI,EAAQ,MAAJA,EAAiB,MAAJA,CAClC,CACA,OAAO5Y,CACT,sDAsBO,SAAuBA,GAC5B,MAAM0Y,EAAQ,IAAI/P,WAAW3I,EAAMiS,QACnC,IAAIuG,EAAS,GACb,IAAA,IAASpY,EAAI,EAAGA,EAAIsY,EAAMvY,OAAQC,IAChCoY,GAAUK,OAAOC,aAAaJ,EAAMtY,IAEtC,OAAO2Y,KAAKP,EACd,qDCmEO,SAA2BQ,EAAYC,EAAUtO,GACtD,MAAMuO,EAAIxR,EAAcsR,IAAetR,EAAczE,IAC/CkW,EAAIzR,EAAcuR,IAAavR,EAAczE,IAC7CmW,EAASzY,KAAKS,IAAI,EAAGT,KAAKQ,IAAI,EAAGwJ,IACvC,MAAO,CACLhD,KAAOuR,EAAEvR,MAASwR,EAAExR,KAAQuR,EAAEvR,MAASyR,EACvCxR,MAAOsR,EAAEtR,OAASuR,EAAEvR,MAAQsR,EAAEtR,OAASwR,EACvC3W,MAAOyW,EAAEzW,OAAS0W,EAAE1W,MAAQyW,EAAEzW,OAAS2W,EAE3C,eDoBO,SAAcF,EAAGC,EAAGxO,GACzB,OAAOuO,GAAKC,EAAID,GAAKvY,KAAKS,IAAI,EAAGT,KAAKQ,IAAI,EAAGwJ,GAC/C,oEAzEO,SAA0BrK,GAC/B,GAAIA,EAAKH,OAAS,EAAG,OAAO,EAC5B,IAAIkZ,EAAY,EAChB,IAAA,IAASjZ,EAAI,EAAGA,EAAIE,EAAKH,OAAQC,KAC1BE,EAAKF,IAAM,GAAKE,EAAKF,EAAI,GAAK,GAAOE,EAAKF,GAAK,GAAKE,EAAKF,EAAI,IAAM,IACtEiZ,IAGJ,OAAOA,GAAa/Y,EAAKH,OAAS,EACpC"}